"""
Kotaro-Engine v2: ç”»åƒè§£æ â†’ 18æ–‡å­—ç”Ÿæˆ

llavaã§å†™çœŸã®è¡¨æƒ…ã‚’è‡ªå‹•åˆ¤å®šã—ã€Kotaro-Engineã§18æ–‡å­—ã‚’ç”Ÿæˆ

ä½¿ç”¨æ–¹æ³•:
    python kotaro_v2.py --image "path/to/photo.jpg" --name "æ "
"""

import ollama
import random
import base64
from pathlib import Path


# =============================================================================
# è¡¨æƒ…ã‚«ãƒ†ã‚´ãƒª
# =============================================================================

EXPRESSION_CATEGORIES = [
    "ç¬‘é¡”",      # ç¬‘ã£ã¦ã„ã‚‹
    "ã‚¯ãƒ¼ãƒ«",    # ã™ã¾ã—ã¦ã„ã‚‹ã€ã‹ã£ã“ã„ã„
    "ã‹ã‚ã„ã„",  # ã‹ã‚ã„ã‚‰ã—ã„è¡¨æƒ…
    "ãµã–ã‘",    # ãµã–ã‘ã¦ã„ã‚‹ã€ãŠã©ã‘ã¦ã„ã‚‹
    "çœŸå‰£",      # çœŸå‰£ãªè¡¨æƒ…
]

# =============================================================================
# ç”»åƒè§£æï¼ˆllavaï¼‰
# =============================================================================

def analyze_photo(image_path: str) -> str:
    """llavaã§å†™çœŸã®è¡¨æƒ…ã‚’è§£æ"""
    
    # ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    image_data = Path(image_path).read_bytes()
    
    # llavaã«è¡¨æƒ…ã‚’èã
    response = ollama.generate(
        model="llava",
        prompt="""ã“ã®å†™çœŸã®äººç‰©ã®è¡¨æƒ…ã‚’1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„ï¼š
- ç¬‘é¡”ï¼ˆç¬‘ã£ã¦ã„ã‚‹ï¼‰
- ã‚¯ãƒ¼ãƒ«ï¼ˆã™ã¾ã—é¡”ã€ã‹ã£ã“ã„ã„ï¼‰
- ã‹ã‚ã„ã„ï¼ˆå¯æ„›ã‚‰ã—ã„è¡¨æƒ…ï¼‰
- ãµã–ã‘ï¼ˆãŠã©ã‘ã¦ã„ã‚‹ï¼‰
- çœŸå‰£ï¼ˆçœŸå‰£ãªè¡¨æƒ…ï¼‰

è¡¨æƒ…ã®åå‰ã ã‘ç­”ãˆã¦ï¼š""",
        images=[image_data],
    )
    
    result = response["response"].strip()
    
    # ã‚«ãƒ†ã‚´ãƒªã«ãƒãƒƒãƒã™ã‚‹ã‹ç¢ºèª
    for cat in EXPRESSION_CATEGORIES:
        if cat in result:
            return cat
    
    return "ç¬‘é¡”"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ


# =============================================================================
# Kotaro-Engineï¼ˆ18æ–‡å­—ç”Ÿæˆï¼‰
# =============================================================================

# è¡¨æƒ…åˆ¥ã®ãŠæ‰‹æœ¬
EXAMPLES = {
    "ç¬‘é¡”": [
        "æ ã•ã‚“ãƒã‚¸å¯æ„›ã„ã€å„ªå‹âœ¨",
        "æ ã•ã‚“ã®ç¬‘é¡”ã€ã“ã‚Œã¯ç¥å›ğŸ“¸",
        "æ ã•ã‚“æ’®ã‚ŒãŸã®æœ€é«˜ã™ãã‚‹âœ¨",
        "æ ã•ã‚“ã„ã„ç¬‘é¡”ã‚‚ã‚‰ã£ãŸğŸ“¸",
    ],
    "ã‚¯ãƒ¼ãƒ«": [
        "æ ã•ã‚“ã‚«ãƒƒã‚³ã‚ˆã™ãã€ç—ºã‚Œã‚‹âœ¨",
        "æ ã•ã‚“ã®ã“ã®è¡¨æƒ…ã€ãƒ¤ãƒã„ğŸ“¸",
        "æ ã•ã‚“ã‚¯ãƒ¼ãƒ«ã™ãã¦å„ªå‹âœ¨",
    ],
    "ã‹ã‚ã„ã„": [
        "æ ã•ã‚“å¯æ„›ã„ã€ã“ã‚Œã¯åå‰‡âœ¨",
        "æ ã•ã‚“ã®å¯æ„›ã•ã€è¦æ ¼å¤–ğŸ“¸",
        "æ ã•ã‚“å¯æ„›ã™ãã¦ç„¡ç†âœ¨",
    ],
    "ãµã–ã‘": [
        "æ ã•ã‚“ã®ã“ã®ãƒãƒªã€æœ€é«˜ğŸ“¸",
        "æ ã•ã‚“é¢ç™½ã™ãã‚‹âœ¨",
        "æ ã•ã‚“ã“ã‚Œå¥½ãã€å„ªå‹ğŸ“¸",
    ],
    "çœŸå‰£": [
        "æ ã•ã‚“ã®çœŸå‰£ãªçœ¼å·®ã—ã€åˆºã•ã‚‹âœ¨",
        "æ ã•ã‚“ã“ã®è¡¨æƒ…ã€ç¾ã—ã„ğŸ“¸",
        "æ ã•ã‚“ã®é›†ä¸­åŠ›ã€ãƒ¤ãƒã„âœ¨",
    ],
}


def generate_comment(model_name: str, expression: str) -> str:
    """è¡¨æƒ…ã«åˆã‚ã›ãŸ18æ–‡å­—ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ"""
    
    examples = EXAMPLES.get(expression, EXAMPLES["ç¬‘é¡”"])
    few_shot = "\n".join([f"- {ex.replace('æ ', model_name)}" for ex in examples])
    
    prompt = f"""è™å¤ªéƒã¨ã—ã¦{model_name}ã•ã‚“ã®å†™çœŸã«ä¸€è¨€ã€‚
è™å¤ªéƒï¼30ä»£å¾ŒåŠã€è½ã¡ç€ã„ãŸå¤§äººã€‚ãƒãƒªã¯ã„ã„ã‘ã©è‹¥è€…ã‚¹ãƒ©ãƒ³ã‚°ã¯ä½¿ã‚ãªã„ã€‚

å†™çœŸã®è¡¨æƒ…: {expression}

ã€ãŠæ‰‹æœ¬ã€‘
{few_shot}

ã€ç¦æ­¢ã€‘åã€ã´ãˆã‚“ã€è‰ã€wã€è‹¥è€…ã‚¹ãƒ©ãƒ³ã‚°

ã€å‡ºåŠ›ã€‘18æ–‡å­—ä»¥å†…ã§1ã¤ã ã‘ï¼š"""
    
    response = ollama.generate(
        model="gemma3:4b",
        prompt=prompt,
        options={"temperature": 0.8, "num_predict": 50}
    )
    
    result = response["response"].strip()
    
    # æ”¹è¡ŒãŒã‚ã‚Œã°æœ€åˆã®è¡Œã ã‘
    if "\n" in result:
        result = result.split("\n")[0]
    
    # åãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰å‰Šé™¤
    result = result.replace("å", "")
    
    # 18æ–‡å­—ã«åˆ‡ã‚Šè©°ã‚
    if len(result) > 18:
        result = result[:17] + "âœ¨"
    
    return result


# =============================================================================
# ãƒ¡ã‚¤ãƒ³
# =============================================================================

def main():
    import argparse
    
    parser = argparse.ArgumentParser(description="Kotaro-Engine v2")
    parser.add_argument("--image", type=str, required=True, help="å†™çœŸã®ãƒ‘ã‚¹")
    parser.add_argument("--name", type=str, default="æ ", help="ãƒ¢ãƒ‡ãƒ«ã•ã‚“ã®åå‰")
    parser.add_argument("--count", type=int, default=3, help="ç”Ÿæˆæ•°")
    
    args = parser.parse_args()
    
    print("\n" + "=" * 50)
    print("ğŸ¯ Kotaro-Engine v2.0 (Vision)")
    print("=" * 50)
    
    # å†™çœŸè§£æ
    print(f"\nğŸ“¸ å†™çœŸ: {args.image}")
    print("ğŸ” è¡¨æƒ…ã‚’è§£æä¸­...")
    
    expression = analyze_photo(args.image)
    print(f"âœ… è¡¨æƒ…: {expression}")
    
    # 18æ–‡å­—ç”Ÿæˆ
    print(f"\nğŸ¯ {args.name}ã•ã‚“ã¸ã®18æ–‡å­—ã‚³ãƒ¡ãƒ³ãƒˆ:")
    print("-" * 40)
    
    for i in range(args.count):
        comment = generate_comment(args.name, expression)
        print(f"  [{i+1}] {comment} ({len(comment)}æ–‡å­—)")
    
    print("-" * 40)
    print("=" * 50 + "\n")


if __name__ == "__main__":
    main()
