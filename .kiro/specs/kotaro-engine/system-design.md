# Kotaro-Engine システム設計書
## Claude Opus 4.5 統合設計用

---

## 1. プロジェクト概要

### 1.1 目的
SNS投稿（X）におけるモデル写真の「一言コメント」を、**18文字以内**でローカルAIにより自動生成する。

### 1.2 コンセプト: 「完杯」
- 撮影者の意図・技術を排除
- モデルの「ありのままの魅力」に圧倒された瞬間を言語化
- 評価ではなく**純粋な賞賛**

---

## 2. ハードウェア環境

| 項目 | スペック |
|------|---------|
| GPU | NVIDIA GeForce RTX 4060 (VRAM 8GB) |
| CPU | AMD Ryzen 5 5500 (6C/12T) |
| RAM | 64GB DDR4 |
| OS | Windows (WSL2対応) |

---

## 3. 推論アーキテクチャ: 2層展開

### Tier-A: 検証・量産（高速）
| 項目 | 仕様 |
|------|-----|
| モデル | Gemma 2 2B Instruct (GGUF Q6_K) |
| エンジン | Ollama / llama-cpp-python |
| VRAM消費 | ~2GB |
| 用途 | ロジック検証、A/Bテスト、量産 |

### Tier-B: 本番（高品質）
| 項目 | 仕様 |
|------|-----|
| モデル | Gemma 2 9B Instruct (EXL2 5.0-6.0 bpw) |
| エンジン | ExLlamaV2 |
| VRAM消費 | ~5-6.5GB |
| 用途 | 語彙の深み、「刺さり」の最大化 |

---

## 4. コアモジュール設計

### 4.1 Visual Sentiment Bridge（写真解析）
```
[画像入力] → MediaPipe(顔検出) → DeepFace(感情分析) → [感情スコア]
                                                           ↓
                                               [プロンプト修飾子に変換]
```

**出力例:**
- `Happy: 95%` → `「満面の笑みを称えよ」`
- `Neutral: 88%` → `「静かな美しさを讃えよ」`

### 4.2 Strict Constraint Engine（18文字制限）
```python
# 実装方針
1. GBNF文法: トークン生成を物理的に18文字で強制終了
2. Length Guard: 超過時は高速リライト・ループ
3. LogitProcessor: 18文字接近時にEOSの確率を急上昇
```

### 4.3 Anti-AI Vocabulary Control（語彙制御）
```json
{
  "logit_bias": {
    "素敵": -100,
    "最高": -100,
    "プロ": -100,
    "仕事": -100,
    "頑張": -100
  },
  "ng_chars": ["死", "バグ", "壊", "悲", "止"]
}
```

### 4.4 Few-shot Context Manager
```
[感情スコア] → [対応する90点例文を3-6本選択] → [プロンプトに注入]
```

**90点例文サンプル:**
```
栞さん、ありのままが眩しすぎる✨
可愛さが規格外。栞さん、完杯です📸
栞さん、その瞳に吸い込まれる✨
シャッターが止まらない。栞さん無敵✨
```

---

## 5. システムフロー

```
┌─────────────────────────────────────────────────────────┐
│                    Editor UI (Next.js)                   │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼ 画像ドロップ
┌─────────────────────────────────────────────────────────┐
│              Visual Sentiment Bridge                     │
│    MediaPipe(顔検出) → DeepFace(感情分析)                │
│              → 感情スコア抽出 (GPU: ~10ms)               │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼ 感情スコア + モデル名
┌─────────────────────────────────────────────────────────┐
│              Kotaro Prompt Builder                       │
│    - Few-shot選択（感情に基づく）                        │
│    - NGワード封鎖設定                                    │
│    - 18文字制限パラメータ                                │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼ 構築済みプロンプト
┌─────────────────────────────────────────────────────────┐
│              Local LLM Inference                         │
│    Gemma 2 (2B or 9B) + Constraint Engine               │
│              → 18文字コメント生成 (GPU: ~100ms)          │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              Editor UI: 一言コメント欄に自動反映          │
└─────────────────────────────────────────────────────────┘
```

---

## 6. Next.jsアプリ統合設計

### 6.1 APIエンドポイント
```
POST /api/kotaro/generate
├── Request:  { image: base64, modelName: string }
└── Response: { comment: string, emotion: string }
```

### 6.2 Pythonバックエンド連携
```
Next.js → FastAPI (localhost:8000) → Ollama/ExLlamaV2
```

### 6.3 UI変更
- **削除**: 表情タイプ選択プルダウン
- **追加**: 🔄 再生成ボタン（ワンクリックで別の18文字を取得）

---

## 7. 実装ロードマップ

| Phase | 内容 | 目標 |
|-------|------|------|
| 1 | Gemma 2 2B + Ollama環境構築 | 制約ロジック完成 |
| 2 | 90点Few-shot + NGワード封鎖 | 品質基盤確立 |
| 3 | MediaPipe連携 | 表情自動判別 |
| 4 | Gemma 2 9B載せ替え | 「刺さり」獲得 |
| 5 | Next.js統合 | 本番運用開始 |

---

## 8. Opus 4.5への設計依頼事項

1. **メモリレイアウト設計**: 8GB VRAMをMediaPipe・LLM・KVキャッシュで最適分配
2. **非同期パイプライン**: 画像解析とLLM推論の並列実行構造
3. **Pythonクラス設計**: KotaroEngine, ConstraintGuard, SentimentBridge のインターフェース
4. **エラーハンドリング**: 18文字超過時のフォールバック戦略
