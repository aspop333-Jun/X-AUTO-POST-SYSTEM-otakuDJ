# kotaro_4_連単設定値_同点処理_統合版（V4.3 / Anti-P04 Lock）
**狙い**：あなたのベンチ結果（28枚中 P04=82%）は、**ロジックの問題というより「Bが常に高く出ている」上流スコアの偏り**で、決定木が **P04にロック**されている。  
V4.3は **P04ロック解除パッチ**として、(1)Bの過剰優位を抑える、(2)B分岐をフラグ優先に変える、(3)同点/僅差で主役を適切に逃がす —— を追加。

---

## 0. あなたのレポートから見えた致命点（事実）
- 多数画像で **A=3.7 / B=4.0 / C=2.0 / D=1.8 がほぼ固定**  
- B主役になりやすい上に、B分岐が **「C>DならP04」** なので  
  `C(2.0) > D(1.8)` が固定 → **P04固定** になっている

---

## 1. 入力（0〜5）
- `A,B,C,D,E`（各0〜5）
- Flags（あなたの実装で既に出ているもの）
  - `close_dist` / `talk_to` / `casual_moment` / `crowd_venue` / `nostalgic` / `costume_strong` / `act_point_or_salute` / `prop_strong` / `group`

> ※現状のFlagsが弱い（ほぼ close_dist/talk_to/casual）ので、V4.3は **それだけでも分布が散る**ように作ってある。

---

## 2. 二次加点（V4.2踏襲）＋ V4.3 追加補正
### 2.1 V4.2の二次加点（最大+1.5クリップ）
- `casual_moment` → `A += 0.7`（=E10相当）
- `nostalgic` → `A += 0.5`（=E09相当）
- `crowd_venue` → `B += 0.7`（=E07/E08相当）
- `group` → `B += 0.5` + `C += 0.5`（=E14相当）
- `talk_to` → `D += 0.5`（=E06相当）
- `close_dist` → `D += 0.3`（=E01相当）
- `costume_strong` → `C += 0.7`（=C07相当）
- `act_point_or_salute` → `C += 0.5` + `D += 0.3`
- `prop_strong` → `B += 0.7`

### 2.2 V4.3 追加補正（Anti-P04 Lock）
**Bが常に高い現象を“決定段”で抑制する。**（上流が直るまでの暫定でも効果大）

#### (A) 「近距離ポートレート」Bペナルティ
- もし `close_dist=1` **かつ** `crowd_venue=0` **かつ** `prop_strong=0` **かつ** `group=0` のとき  
  → `B -= 0.6`

> これで「背景が弱いのにBが4.0固定」みたいな誤爆を落とす。  
> （あなたのログの大半がここに該当してP04固定を生んでいる）

#### (B) “会話距離”Dブースト（分散用）
- もし `talk_to=1` → 追加で `D += 0.2`

#### (C) “余韻”Aブースト（分散用）
- もし `casual_moment=1` → 追加で `A += 0.2`

### 2.3 クリップ
- A,B,C,D,E を 0〜5 にクリップ

---

## 3. 主役（main）決定（A〜Dのみ）
- `M = max(A,B,C,D)`
- **フラット逃がし**：`M <= 2` → P11/P12（V4.2と同じ）
- それ以外：`main = argmax(A,B,C,D)`

### 3.1 僅差逃がし（決定的・再現性あり）
- `top1 - top2 <= 0.3` のとき（僅差）  
  → フラグに一致する方を主役にする（固定順）
  1) `costume_strong=1` なら **C**
  2) `act_point_or_salute=1` なら **D**
  3) `casual_moment=1` なら **A**
  4) `crowd_venue=1 or prop_strong=1 or group=1` なら **B**
  5) それでも決まらない → **A > B > C > D**（規約）

---

## 4. 12パターン決定（V4.3）
### 4.1 固定ID（同じ）
- P01：A主役 / `A>D>C>B`
- P02：A主役 / `A>C>D>B`
- P03：B主役 / `B>D>C>A`
- P04：B主役 / `B>C>D>A`
- P05：C主役 / `C>D>A>B`
- P06：C主役 / `C>B>D>A`
- P07：C主役 / `C>B>A>D`
- P08：D主役 / `D>B>C>A`
- P09：D主役 / `D>A>C>B`
- P10：D主役 / `D>C>B>A`
- P11：Flat_Close
- P12：Flat_Scene

### 4.2 分岐ルール（B主役の“P04固定”を解除）
#### main = A
- `D >= C` → P01
- `C > D` → P02

#### main = B（ここが最重要）
- もし `crowd_venue=1` **または** `group=1` → **P03**
- それ以外で `prop_strong=1` → **P04**
- それ以外で `B - A <= 0.5`（Aが近い） → **P03**（Scene寄り）
- それ以外 → **P04**

> 旧：C>Dで決めてたのがダメ（CとDが固定値だと永久にP04）。  
> 新：**フラグ＆A距離**で決める。

#### main = C
- `group=1` → P07
- それ以外で `costume_strong=1` → P06
- それ以外 → P05

#### main = D
- `act_point_or_salute=1` → P10
- それ以外で `A >= B` → P09
- それ以外 → P08

#### Flat（M<=2）
- `B>=2 or crowd_venue=1 or prop_strong=1 or group=1` → P12
- else → P11

---

## 5. ログの修正（あなたのレポートの「Main」列が怪しい）
あなたの出力は `Main` 列に `B>A>C>D` が入っていて、これは **mainではなく sub4**。  
ログは次の2つを分けて出すこと：
- `main`: A/B/C/D/None
- `sub4`: 例 `B>A>C>D`

---

## 6. 期待される改善（今回の28枚ログ前提）
- close_dist/talk_to/casual_moment が多い現状でも  
  **Bペナルティ＋A/Dブースト**で main が A/B に割れて、P01/P02/P03/P04がまず散る
- crowd_venue / group / prop_strong が効けば P03/P12 へも逃げる

---

## 7. 調整ノブ（1回で収束させる順）
1) `B -= 0.6` を `0.4〜0.9`で調整（P04が多いときは増やす）
2) `B - A <= 0.5` を `0.3〜0.8`で調整（P03/P04の比率）
3) `talk_to` の D追加 `+0.2` を `0.0〜0.3`

---
