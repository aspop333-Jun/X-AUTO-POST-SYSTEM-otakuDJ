# kotaro_4_連単設定値_同点処理_統合版（V4.2）
**対象**：`Kotaro Comment Scoring System V4` に対応する「12パターン決定ロジック」＋「同点処理」＋「フラット逃がし」統合設定  
**目的**：30枚入力でも **12パターンの偏りが極端に出ない**ように、A〜Eスコアから最終パターンを決定する。  

---

## 0. 前提（固定）
- 入力スコア：`A,B,C,D,E`（各0〜5、四捨五入OK）
- **主役（人格）はA〜Dのみ**  
- **E（親近感）は主役にしない**（文体・距離感の補助だけ）
- 4連単＝A〜Dの順位（Eは順位に入れない）

---

## 1. 二次加点（分布散らしパッチ）
> E（親近感）を “配管” として A/B/C/D に微量流し、同じ顔・同じ現場でもサブ順位に差を作る。

### 1.1 二次加点ルール（推奨値）
※各フラグは 0/1（該当しない/する）。  
※二次加点の合計は **最大 +1.5** でクリップ。

- `E10_ふとした瞬間` =1 → `A += 0.7`
- `E09_思い出感` =1 → `A += 0.5`
- `E07_会場` or `E08_人混み` =1 → `B += 0.7`
- `E14_仲間感` =1 → `B += 0.5` ＋ `C += 0.5`
- `E06_話しかけ` =1 → `D += 0.5`
- `E01_距離近い` =1 → `D += 0.3`
- `C07_衣装演出強い` =1 → `C += 0.7`
- `ACT_指差し敬礼手伸ばし` =1 → `C += 0.5` ＋ `D += 0.3`
- `B02_小物強い(傘/看板/配布物)` =1 → `B += 0.7`

### 1.2 クリップ
- `A,B,C,D` は `0〜5` にクリップ
- 二次加点合計が `> 1.5` の場合は、**大きい順に採用**して 1.5 以内に収める

---

## 2. 主役決定（A〜Dのみ）
### 2.1 フラット逃がし（最優先）
- `M = max(A,B,C,D)`
- もし `M <= 2` → **フラット系（P11/P12）に強制**

フラット分岐：
- `B >= 2` もしくは `BG強（会場/看板/ステージ/状況）=1` → **P12（Flat_Scene）**
- それ以外 → **P11（Flat_Close）**

> ここが偏り対策の「逃がし弁」。P11/P12を許可しないと、DやP11がゴミ箱化して偏る。

### 2.2 通常（M >= 3）
- 主役候補：`{A,B,C,D}` のみ  
- `main = argmax(A,B,C,D)`

---

## 3. 同点処理（A〜D）
### 3.1 基本優先順位（固定）
同点の場合は **A > B > C > D** を優先（最終決着の規約）

### 3.2 人格委譲ルール（V4必須・更新版）
> Gemini提案の「Eが最高でも…」ルールを、V4の前提（E主役禁止）に合わせて“無害化”して残す。

- `E` が最高点でも、**主役はA〜Dで決める**（Eは主役にならない）
- ただし「Eが高い＝距離が近い」場合は、文体のみ変更：
  - `E >= 4` → 近い口調（砕ける/呼びかけ多め）
  - `E == 3` → 通常
  - `E <= 2` → 丁寧寄り（距離を取る）

---

## 4. 12パターン決定ロジック（V4.2）
> 「主役（トリガー）」＋「補助の並び」で 12種類に割り振る。  
> 偏りが出やすい D と フラットを **さらに枝分かれ**させて分散。

### 4.1 パターン一覧（固定ID）
- **P01｜余韻（Soft）**：主役A、サブ `A>D>C>B`
- **P02｜余韻（Perform）**：主役A、サブ `A>C>D>B`

- **P03｜構図（Scene）**：主役B、サブ `B>D>C>A`
- **P04｜構図（Complex）**：主役B、サブ `B>C>D>A`

- **P05｜クール（Cool）**：主役C、サブ `C>D>A>B`
- **P06｜キャラ（Character）**：主役C、サブ `C>B>D>A`
- **P07｜対比（Group）**：主役C、サブ `C>B>A>D`

- **P08｜温度（Bright）**：主役D、サブ `D>B>C>A`
- **P09｜温度（Soft）**：主役D、サブ `D>A>C>B`
- **P10｜温度（Action）**：主役D、サブ `D>C>B>A`

- **P11｜フラット（Close）**：主役なし、サブ `D>B>A>C`
- **P12｜フラット（Scene）**：主役なし、サブ `B>D>C>A`

### 4.2 分岐ルール（決定木）
#### main = A のとき
- `D >= C` → **P01**
- `C > D` → **P02**

#### main = B のとき
- `D >= C` → **P03**
- `C > D` → **P04**

#### main = C のとき
- `GRP=1`（複数人/仲間感/ペア強）→ **P07**
- それ以外で `CHAR=1`（衣装/役/演出強い）→ **P06**
- それ以外 → **P05**

#### main = D のとき
- `ACT=1`（指差し/敬礼/手伸ばし等）→ **P10**
- それ以外で `A >= B` → **P09**
- それ以外 → **P08**

#### フラット（M <= 2）のとき
- 2.1 の条件で **P11/P12** を決める（上記固定）

---

## 5. サブ4連単の生成（A〜Dの順位）
- `A,B,C,D` を降順ソート
- 同点は 3.1 の優先順位（A>B>C>D）で決着
- 例：`A>D>C>B`

> ※P01〜P12に紐づく「推奨サブ」を持つが、  
> 実際の4連単は **計算値**を優先し、パターンは「型」として使う（偏り防止）。

---

## 6. 出力（API/ログ用）
必ず以下を返す（デバッグしやすい）：
- `pattern_id`（P01〜P12）
- `main`（A/B/C/D/None）
- `sub4`（例：A>D>C>B）
- `scores`（二次加点後のA〜E）
- `mods`（文体：close/normal/polite、根拠：E）

---

## 7. テスト条件（この30枚でやる）
目標：
- **出現パターン数：8〜12**
- **最大偏り：30%未満**（30枚なら9枚以上が1パターンはNG）

偏った場合に触る場所（順番固定）：
1) **フラット閾値**：`M<=2` を `<=1` にする（フラットが多すぎる時のみ）  
2) 二次加点の量（1章）を ±0.2 で微調整  
3) D分岐（P08/P09/P10）の条件（A>=B など）を変える

---

## 8. 変更履歴
- V4.0：Eを親近感へ置換、E主役禁止
- V4.1：P11/P12フラット逃がし確定
- V4.2：二次加点（分布散らしパッチ）＋決定木を統合
