# 進捗報告書 (2026/01/29)

## 1. プロジェクト概要
- **現在フェーズ:** Phase 3 (UI統合 & API一元化)
- **全体ステータス:** ⚠️ 要注意 (Scoring Imbalance & VRAM Risk)
- **本日の活動:** 全コードベースのレビューおよび進捗・課題の整理

## 2. コードレビュー結果 (2026/01/29実施)

### A. バックエンド (`kotaro_api.py` / `kotaro_scoring_v4.py`)
*   **現状:**
    *   V4.2ロジック (`KotaroScorerV4`) が適用され、LMDeploy (Qwen2-VL) をバックエンドとして稼働中。
    *   APIサーバーは Port 8000 でリクエストを受け付け、Port 23334 の VLM サーバーへ問い合わせる構成。
*   **検出された課題:**
    1.  **VRAM管理とモデル切り替えの欠如:**
        *   `vision_core.py` (MiniCPM-V実装) は存在するが、`kotaro_api.py` からは使用されていない。
        *   現在の実装は Qwen2-VL に全依存しており、8GB VRAM 環境下で MiniCPM-V を併用（または切り替え）するロジックが実装されていない。将来的な機能拡張（ファクトチェック等）のブロッカーとなる可能性がある。
    2.  **スコアリングロジックの偏り (P06問題):**
        *   `kotaro_scoring_v4.py` 内で、`f_costume` (衣装強いフラグ) に対する加点が `+0.7` と非常に高い。
        *   さらに `decide_pattern` 内の "Close Game" ロジックにて、「接戦かつ `f_costume` がTrueなら無条件でC要素(P06)を選択する」という処理が存在するため、P06への強制遷移が多発している。

### B. フロントエンド (`next-app/src/components/editor/TextEditor.tsx`)
*   **現状:**
    *   V4 API との統合は完了している。
    *   `ScoringVisualization.tsx` を通じて、APIから返却される詳細スコア (`element_scores`) や検出フラグ (`flags`) を正しく可視化できている。
    *   フィードバック機能（いいねボタン）も実装済み。
*   **評価:**
    *   UI/UX の実装状態は良好。バックエンドのロジック改善に即座に対応できる状態にある。

### C. インフラ・構成
*   **現状:**
    *   WSL2 + NVIDIA GPU 環境での動作を前提としている。
    *   `start_kotaro.sh` 等のスクリプト群は整備されているが、Python環境依存 (requirements.txt) が LMDeploy と MiniCPM-V で競合しないか注意が必要。

## 3. ベンチマーク分析 (V4.7 Report 参照)

最新のベンチマーク結果 (`Progress/V4_7_BENCHMARK_REPORT.md`) において、以下の著しい偏りが確認された。

| パターン分類 | 発生率 | 評価 |
| :--- | :--- | :--- |
| **P06 (Character/衣装)** | **30.0%** | **過多** (目標: 10-15%) |
| **P11/P12 (Flat/無難)** | **53.4%** | **過多** (目標: 30%以下) |
| **感情系 (P01, P05, P07-P10)** | **ほぼ0%** | **消失** (致命的) |

**分析:**
「衣装 (f_costume)」や「真正面 (pose_front_true)」といった視覚的に分かりやすいフラグがスコアを支配しており、本来抽出したい「余韻 (A)」や「温度感 (D)」がかき消されている。

## 4. ネクストステップ (Action Items)

### 優先度: 高 (Immediate)
1.  **スコアリングロジック修正 (Fix P06 Bias):**
    *   `f_costume` の加点を `+0.7` → `+0.3` 程度に抑制。
    *   `decide_pattern` 内の強制遷移ロジックを廃止または緩和する。
    *   修正後、再度ベンチマークを実行し、感情系パターン (P01-P10) の出現率回復を確認する。

### 優先度: 中 (Strategic)
2.  **モデルスイッチャー (Model Switcher) の設計と実装:**
    *   VRAM 8GB の制約内で、Qwen2-VL と MiniCPM-V を動的に切り替える（ロード/アンロード）仕組みを `kotaro_api.py` に導入する。
    *   または、推論パイプラインを「軽量モデル (MiniCPM-V) でスクリーニング → 必要なら重量モデル」という構成に見直す (V5構想)。

### 優先度: 低 (Maintenance)
3.  **プログレスレポートの定期更新:**
    *   日次の進捗を `Progress/` フォルダに記録し、開発の軌跡を可視化し続ける。
