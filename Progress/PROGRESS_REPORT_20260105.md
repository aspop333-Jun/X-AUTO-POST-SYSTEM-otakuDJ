# 進捗管理レポート (2026-01-05)

## 1. プロジェクト概要
**プロジェクト名**: X-AUTO-POST-SYSTEM-otakuDJ
**目的**: イベント写真自動投稿システム（"CANDY虎太郎"ペルソナによる18文字エモコメント生成）
**現状ステータス**: フェーズ3（UI/UX統合・API一元化）進行中

前日(1/4)のE2Eテスト成功を受け、本日(1/5)はコードベース全体のレビューと、インフラ・ロジック間の整合性確認を実施しました。
フロントエンドは順調に統合されていますが、バックエンド起動スクリプトとVRAM管理戦略に重大な不一致が発見されました。

---

## 2. コンポーネント別進捗詳細

### 🤖 AI エンジン (Kotaro Engine V4.2)
**ステータス: ⚠️ 注意 (Backend Mismatch Detected)**
- **API (`kotaro_api.py`)**:
  - V4.2ロジック（LMDeploy/Qwen2-VL利用）で稼働中。
  - **問題**: `start_kotaro.sh` が `ollama serve` (port 11434) を起動する設定のまま放置されており、APIが期待する `localhost:23334` (LMDeploy) と不整合を起こしています。Windows環境(`.bat`)のみ正常動作しています。
  - **スコアリング**: `kotaro_scoring_v4.py` の "Close Game" ロジックにおいて、`f_costume` フラグが有効な場合、+0.7の加点に加え、僅差(0.3差以内)で強制的に **P06 (Character)** を勝利させるロジックが存在し、これが「P06支配問題」の原因と特定されました。

- **Vision Core (`vision_core.py`)**:
  - MiniCPM-V 2.6 int4 実装済みですが、現在は **不使用** です。
  - RTX 4060 (8GB VRAM) 環境では、LMDeploy (Qwen2-VL) が常駐するため、MiniCPMを同時にロードできません。動的なモデル切り替え（Unload/Load）機構が必要です。

### 💻 フロントエンド (Next.js)
**ステータス: ✅ 順調 (Integrated)**
- **TextEditor (`next-app/src/components/editor/TextEditor.tsx`)**:
  - `ScoringVisualization` コンポーネントが統合され、V4.2のAPIレスポンス（`pattern`, `element_scores`, `flags`）を正しく可視化しています。
  - コメント生成、フィードバック送信機能も実装済み。

### 🏗️ インフラストラクチャ
**ステータス: ⚠️ WSL環境要修正**
- **Windows (`start_lmdeploy_system.bat`)**: 正常。LMDeployをポート23334で起動します。
- **Linux/WSL (`start_kotaro.sh`)**: **要修正**。旧式のOllama構成のままです。

---

## 3. コードベースレビュー結果

### ⚠️ 重大な課題 (Critical Issues)

1.  **起動スクリプトの不整合 (Backend Mismatch)**
    - **症状**: Linux/WSL環境で `start_kotaro.sh` を使用すると、APIサーバーは起動するが、推論バックエンド（LMDeploy）が存在しないためエラーになる。
    - **対策**: `start_kotaro.sh` を書き換え、`scripts/launch_qwen2.py` を呼び出すように変更する必要がある。

2.  **スコアリングロジックのバイアス (P06 Dominance)**
    - **症状**: ベンチマークで P06 (Cosplay/Character) が過剰に選出される。
    - **原因**: `kotaro_scoring_v4.py` 内の `decide_pattern` 関数にて、1位と2位の差が0.3以内の場合、`f_costume` がTrueなら無条件で P06 ルート（Pattern C）を選択するロジックが強すぎる。
    - **対策**: 強制選択ロジックを緩和するか、閾値を厳しくする。

3.  **VRAMリソース競合 (Resource Conflict)**
    - **症状**: `vision_core.py` (MiniCPM) と `kotaro_api.py` (Qwen2-VL) が同時にVRAMを要求する設計になっているが、8GB VRAMでは共存不可。
    - **対策**:
        - A案: Qwen2-VL 一本化（現在の方向性）
        - B案: リクエストごとにモデルを入れ替える（遅延大）
        - **推奨**: 当面はA案（Qwen2-VL専任）で進め、`vision_core.py` は "Legacy/Alternative" として扱う。

### 🔍 注目ファイル
- **`kotaro_scoring_v4.py`**: P06支配の修正が必要。
- **`start_kotaro.sh`**: 直ちに修正が必要。
- **`kotaro_api.py`**: `vision_core` のインポートがなく、事実上 Qwen2-VL 専用になっている（現状の構成と一致しているが、ドキュメントと乖離あり）。

---

## 4. 今後のアクションプラン (Next Steps)

### 短期目標 (明日〜明後日)
1.  **インフラ修正**:
    - `start_kotaro.sh` を `launch_qwen2.py` (LMDeploy) 対応に修正し、WSL環境での稼働を保証する。
2.  **ロジック調整**:
    - `kotaro_scoring_v4.py` の P06 強制ロジックを緩和し、他のパターン（P01-P04）が出やすくする。
3.  **ドキュメント更新**:
    - `vision_core.py` の位置付け（現状は予備）を明確化し、APIサーバーがQwen2-VL依存であることを明記する。

### 中期目標 (今週中)
1.  **実画像ベンチマーク**:
    - 修正後のスコアリングロジックを用いて、実際のイベント写真50枚程度でパターンのバラつきを確認する。
2.  **フロントエンド完全移行**:
    - 旧 `app/` フォルダの廃止検討。

---
*Report generated by Gemini CLI Agent*
