# 進捗管理レポート (2026-01-28)

## 1. プロジェクト概要
**プロジェクト名**: X-AUTO-POST-SYSTEM-otakuDJ
**目的**: イベント写真自動投稿システム（"CANDY虎太郎"ペルソナによる18文字エモコメント生成）
**現状ステータス**: フェーズ3（UI/UX統合 & API一本化）進行中

本日は全コードベースの包括的レビューを実施しました。フロントエンド（Next.js）の実装は順調に進んでいますが、バックエンド（Python）において「構成の二重化」と「リソース競合」の重大なリスクが特定されました。

---

## 2. コンポーネント別進捗詳細

### 🤖 AI エンジン (Kotaro Engine)
**ステータス: ⚠️ 要構成整理**
- **Comment Generation (`kotaro_api.py`)**:
  - V4.2ロジック（A-E採点＋フラグ判定）が稼働中。
  - バックエンドは `LMDeploy` (Qwen2-VL) を `localhost:23334` 経由で使用。
  - **問題**: `vision_core.py` (MiniCPM-V) が実装されているものの、APIからは使用されておらず、リソースの無駄が生じています。
- **Scoring Logic (`kotaro_scoring_v4.py`)**:
  - V4.6.1ロジック（P03への分散、Anti-P04 Lock）実装済み。
  - **課題**: `top1_score <= 2.0` の条件で P11/P12 に流れるロジックが、現在のベンチマーク（P11/P12の支配）の主因となっています。

### 💻 フロントエンド
**ステータス: 🏗️ 部分的統合完了**
- **TextEditor (`TextEditor.tsx`)**:
  - `http://localhost:8000/generate` への接続が完了しており、スコアリング可視化 (`ScoringVisualization`) も機能しています。
- **ImageEditor (`ImageEditor.tsx`)**:
  - クロップ機能、フィルタ機能は実装済み。
  - Cameko検索 (`/api/cameko-search`) は実装されていますが、メタデータ抽出やAI生成との連携機能が `TODO` のままです。

### 🏗️ インフラストラクチャ
**ステータス: ⚠️ 不整合あり**
- **依存関係**: `requirements-kotaro.txt` に `lmdeploy` が含まれていませんが、実際の運用（`scripts/launch_qwen2.py`）では必須となっています。
- **ポート競合**: ローカルAPI (`kotaro_api.py`) と Gemini API (`api/main.py`) が共に `port 8000` を使用する設定になっており、同時起動が不可能です。

---

## 3. コードベースレビュー結果 (Deep Dive)

### 🚨 Critical Issues (優先対応事項)

1.  **ポート8000の競合 (Port Conflict)**
    - `kotaro_api.py` (Local Qwen) と `api/main.py` (Cloud Gemini) が共にポート8000を奪い合っています。
    - **推奨**: Gemini版を `api/main_gemini.py` 等にリネームし、デフォルトポートを変更するか、統合ゲートウェイを作成する必要があります。

2.  **バックエンドの二重化 (Backend Duality)**
    - `vision_core.py` (MiniCPM-V) はRTX 4060向けに高度に最適化されていますが、現在のメインAPI `kotaro_api.py` はこれを無視し、LMDeploy (Qwen2-VL) を使用しています。
    - **判断**: 8GB VRAM環境では両方のモデルを展開することは不可能です。どちらか一方（現状はQwen2-VLが優勢）に統一し、不要なコードをアーカイブする必要があります。

3.  **依存パッケージの欠落**
    - `lmdeploy` が `requirements-kotaro.txt` に記載されていません。環境構築時のトラブル要因となります。

### ⚠️ Performance & Quality

1.  **スコアリングの偏り (P11/P12 Imbalance)**
    - ベンチマーク結果において P06, P11, P12 が支配的です。
    - `kotaro_scoring_v4.py` 内の `if top1_score <= 2.0: main_key = "None"` という判定が厳しすぎ、多くの画像を「特徴なし（P11/P12）」に分類してしまっています。この閾値を下げる（例: 1.5）か、ロジックの再考が必要です。

---

## 4. 今後のアクションプラン (Next Steps)

### 短期目標 (明日以降)
1.  **インフラ整合性の確保**:
    - `api/main.py` の退避・リネーム（ポート競合解消）。
    - `requirements-kotaro.txt` への `lmdeploy` 追加。
2.  **ImageEditorの機能実装**:
    - 未実装の `onExtractMetadata` 等をバックエンドに接続する。
3.  **スコアリング調整**:
    - `top1_score` の閾値緩和による P11/P12 率の低減。

### 中期目標
1.  **ビジョンモデルの最終決定**:
    - Qwen2-VL (LMDeploy) と MiniCPM-V (`vision_core.py`) のどちらを正とするか確定し、コードベースをクリーンアップする。

---
*Report generated by Jules (AI Agent) - 2026-01-28*
