# Progress Report 2026-01-30

## 1. 概要 (Status)
- **Phase:** Phase 3 (UI Integration & API Unification)
- **Date:** 2026-01-30
- **Status:** 🟡 **Caution** (インフラ統合とスコアリングの課題により進行遅延)

## 2. 全コードレビュー結果 (Code Review Findings)

本日のコードレビューにより、以下の重要課題が特定されました。

### A. スコアリングロジックの不均衡 (`kotaro_scoring_v4.py`)
- **現状:** P06 (キャラ/Costume), P11 (フラット), P12 (フラット) の出現率が異常に高い（合計80%超）。
- **原因:**
  1. `apply_secondary_scoring` において `f_costume` フラグが検出されると、自動的に `C` (Cool/Gap) に +0.7 の加点が行われる。
  2. ベンチマーク結果において `costume_strong` はほぼ全ての画像で `True` となっている。
  3. `decide_pattern` において `main_key == "C"` かつ `f_costume` があると、無条件で `P06` に固定される ("Anti-P04 Lock" の副作用)。
  4. スコアが低い場合 (Top1 <= 2.0) のフォールバック先が P11/P12 しかない。

### B. インフラとVRAMの競合 (`kotaro_api.py` vs `vision_core.py`)
- **現状:**
  - `kotaro_api.py` は LMDeploy (Port 23334) 経由で `Qwen2-VL-2B` を常時使用している。
  - `vision_core.py` は `MiniCPM-V-2.6-int4` を使用するように設計されているが、APIからは一切呼ばれていない。
- **課題:**
  - RTX 4060 (8GB VRAM) 環境下では、Qwen2-VL と MiniCPM-V を同時にメモリに乗せることは不可能。
  - `kotaro_api.py` にはモデルのアンロード/スイッチング機構が実装されていない。
  - `vision_core.py` には V4.2 準拠の採点ロジック (A-Eスコア + フラグ検出) が実装されておらず、単なる描写分析に留まっている。

### C. フロントエンド統合 (`next-app`)
- **TextEditor.tsx:** Python Backend (`localhost:8000/generate`) と正常に連携。スコアリング可視化も実装済み。
- **ImageEditor.tsx:** Next.js API Routes (`/api/cameko-search`) を使用する設計となっており、Python Backend とは分離されている。これは設計通りだが、Vision機能の分散管理に注意が必要。

## 3. リスクと課題 (Risks)
1.  **VRAM 8GB の壁:** 現状の構成では Vision Core (MiniCPM) を有効化できない。
2.  **感情パターンの欠如:** P01, P05, P07, P08, P09 などの「エモい」パターンが出現せず、機械的な P06/P11 ばかり生成される。

## 4. 次のアクション (Next Steps)

### Priority High: インフラ統合
1.  **モデルスイッチングの実装:**
    - `kotaro_api.py` に、リクエストに応じて `vision_core` をロード・アンロードするロジックを追加する（または LMDeploy を一時停止する仕組み）。
2.  **Vision Core の V4 対応:**
    - `Qwen2-VL` で使用している V4.2 プロンプト (A-E採点, フラグ検出) を `vision_core.py` (MiniCPM-V) に移植する。

### Priority Medium: スコアリング修正
1.  **`f_costume` の重み調整:**
    - 一律 +0.7 の加点を廃止し、より条件を厳格化するか、加点幅を +0.3 程度に抑える。
2.  **Close Game Logic の見直し:**
    - 接戦時に安易に `C` (Costume) を優先するロジックを緩和する。

---
*Report generated by AI Assistant (Jules)*
