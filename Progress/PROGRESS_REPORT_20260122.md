# 進捗管理レポート (2026-01-22)

## 1. プロジェクト概要
**プロジェクト名**: X-AUTO-POST-SYSTEM-otakuDJ (Kotaro-Engine)
**目的**: イベント写真自動投稿システム（"CANDY虎太郎"ペルソナによる18文字エモコメント生成）
**現状ステータス**: ⚠️ **フェーズ2.5 リファクタリング & インフラ統合**

## 2. エグゼクティブ・サマリー
**【本日の実施事項：全コードレビュー & ステータス確認】**
1. ⚠️ **インフラの「Split-Brain」状態を確認**
   - WSL側 (`start_kotaro.sh`) が `Ollama` を参照している一方、Windows側 (`start_lmdeploy_system.bat`) は `LMDeploy` (scripts/launch_qwen2.py) を正しく参照しています。
   - `kotaro_api.py` は `LMDeploy (port 23334)` を参照しており、WSL単体で起動するとバックエンド不在でエラーになるリスクがあります。

2. ⚠️ **スコアリングロジックのバージョン混在**
   - `kotaro_api.py` のヘッダーは "V4.2" ですが、内部で呼び出している `kotaro_scoring_v4.py` は "V4.6.1" (P03 Scatter/B-gate) のロジックを含んでいます。
   - `kotaro_api.py` 内のコメント生成関数名が `call_kotaro_generation_v3` となっており、命名規則の不一致が見られます。

3. ⚠️ **ベンチマークスコアの偏り (V4.7)**
   - 最新の `V4_7_BENCHMARK_REPORT.md` によると、P06 (30%), P11 (26.7%), P12 (26.7%) が支配的で、感情系パターン (P01, P05, P08-P10) が全く出ていません。
   - `kotaro_scoring_v4.py` 内の `top1_score <= 2.0` の条件が P11/P12 へ強力に誘導している可能性があります。

4. 🚧 **フロントエンド未実装機能**
   - `ImageEditor.tsx` に `Cameko Search`, `Fact Check`, `Metadata Extraction` のプレースホルダーがありますが、バックエンド接続は未実装です。

---

## 3. コンポーネント別ステータス

| コンポーネント | バージョン/状態 | 課題 |
|:---|:---|:---|
| **Kotaro API** | V4.2 (表記) | 実態は V4.6.1+。命名の不整合あり。 |
| **Scoring Logic** | V4.6.1 (Mixed) | V4.7ベンチマークでP06/P11/P12に極端に偏る。 |
| **Infra (WSL)** | ❌ 構成不整合 | `start_kotaro.sh` が不要なOllamaを起動しようとする。 |
| **Infra (Win)** | ✅ 正常 | `start_lmdeploy_system.bat` は正しい構成。 |
| **Frontend** | Phase 3.0 | ImageEditorの高度な機能が未接続。 |

---

## 4. 詳細分析結果

### A. スコアリングの偏り (V4.7 Benchmark Analysis)
- **現象**: 30枚中、P06, P11, P12だけで83%を占めている。
- **原因**: `decide_pattern` 内で `top1_score <= 2.0` の場合、無条件で P11/P12 に流れるロジック（Flat Escape）が強すぎる、またはVLMのスコア出力が全体的に低い（2.0以下が多い）可能性があります。

### B. インフラ不整合
- `start_kotaro.sh` は `ollama serve` を実行していますが、現在の `kotaro_api.py` は `LMDEPLOY_API_URL = "http://localhost:23334/v1"` をハードコードしています。WSL環境のみで開発する場合、APIがバックエンドと通信できません。

---

## 5. Next Steps (優先度順)

1. **インフラ一本化 (Critical)**
   - `start_kotaro.sh` を修正し、Ollamaを排除して `scripts/launch_qwen2.py` (LMDeploy) を起動するように変更する。
   - `requirements-kotaro.txt` から不要な `ollama` 依存を削除。

2. **スコアリングロジックの調整 (High)**
   - `kotaro_scoring_v4.py` の `Flat Escape` 条件 (`top1_score <= 2.0`) を緩和、またはVLMのプロンプトでスコアのレンジを調整する。
   - P06 (キャラ) の過剰判定を抑制（`costume_strong` フラグの重み見直し）。

3. **APIコードのクリーンアップ (Medium)**
   - `kotaro_api.py` のバージョン表記を実態に合わせて V4.7 等へ更新。
   - 関数名 `call_kotaro_generation_v3` をリネーム。

4. **フロントエンド機能実装 (Low)**
   - `ImageEditor.tsx` の Cameko/FactCheck APIエンドポイントの実装。

---
*Report generated by Jules (AI Agent)*
