# 🐯 Kotaro-Engine Progress Report (2026-01-27)

## 1. Phase Status
- **Current Phase:** Phase 3 (UI Integration & API Unification)
- **Status:** In Progress (Infrastructure Repairs & Module Integration)

## 2. Code Review & Updates
### Infrastructure (Startup)
- **Problem:** `start_kotaro.sh` がレガシーな Ollama バックエンドを起動しようとしており、LMDeploy/Qwen を必要とする現在の `kotaro_api.py` (V4.2) と不整合を起こしていました。
- **Fix:** `start_kotaro.sh` を修正し、`scripts/launch_qwen2.py` を実行してポート 23334 で LMDeploy サーバーを起動するように変更しました。API 起動前にサーバーの準備完了を待機するヘルスチェックも追加しました。
- **Result:** 起動パイプラインが V4.2 アーキテクチャ (GPU -> LMDeploy -> API -> Frontend) と整合しました。

### API Conflict Resolution
- **Problem:** `api/main.py` (Gemini 実装) と `kotaro_api.py` (Kotaro Engine) が共にポート 8000 を使用しようとして競合していました。
- **Fix:** `api/main.py` を `api/main_gemini_deprecated.py` にリネームし、競合を解消しつつアクティブなバックエンドを明確化しました。

### Vision Core Integration
- **Update:** `vision_core.py` (MiniCPM-V モジュール) に `analyze_v4` メソッドを追加しました。
- **Details:** この新しいメソッドは、V4.2 のスコアリングロジック (A-E スコア + フラグ) を MiniCPM-V のプロンプト構造内で完全に実装しています。
- **Significance:** これにより、必要であれば `kotaro_api.py` 内の Qwen ベースの VLM 分析を `vision_core.py` に置き換える準備が整いました。

## 3. Risks & Blockers
### 🔴 VRAM Resource Conflict (Critical)
- **Issue:** システムの VRAM リソース限界 (RTX 4060 / 8GB)。
- **Detail:** Qwen2-VL (LMDeploy) と MiniCPM-V (VisionCore) を同時に実行することはできません。
- **Constraint:** VLM バックエンドとして **どちらか一方** のモデルを選択する必要があります。現在は `kotaro_api.py` が Qwen を API 経由で使用していますが、`vision_core.py` は MiniCPM をローカルにロードします。
- **Decision Required:** MiniCPM-V (`vision_core.py`) が Qwen よりも優れたスコアリング精度/安定性を提供するか評価する必要があります。もし優れているなら、`vision_core.py` へ完全移行し、LMDeploy への依存を排除すべきです。

### 🟠 Benchmark Imbalance
- **Issue:** V4.7 ベンチマークにおいて P06/P11/P12 の支配と感情系パターンの欠如が見られます。
- **Status:** 調査待ち。VLM モデルが安定した後、`kotaro_scoring_v4.py` のスコアリングロジック (Anti-P04 lock 等) の調整が必要になる可能性があります。

## 4. Next Steps
1. **Integration Testing:** 新しい `vision_core.py` の V4 スコアリング (`analyze_v4`) をサンプル画像でテストし、JSON 出力形式とスコア分布を検証する。
2. **Architecture Decision:** Qwen と MiniCPM の V4 結果を比較し、プライマリ VLM を選定する。
3. **Frontend Verification:** `TextEditor.tsx` がライブ API からのスコアリング可視化を正しく表示しているか検証する。

---
*Report generated by Jules (AI Agent)*
