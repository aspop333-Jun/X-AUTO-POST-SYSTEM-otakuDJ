# 進捗管理レポート (2026-01-16)

## 1. プロジェクト概要
**プロジェクト名**: X-AUTO-POST-SYSTEM-otakuDJ
**目的**: イベント写真自動投稿システム（"CANDY虎太郎"ペルソナによる18文字エモコメント生成）
**現状ステータス**: フェーズ2.5（統合・リファクタリング・論理整合）
**シミュレーション日付**: 2026-01-16

本システムは、バックエンド論理のV4移行が完了し、フロントエンドとの接続も一部完了しています。しかし、起動スクリプトの不整合や、実装されていない「孤立コンポーネント」の存在が明らかになっています。

---

## 2. コンポーネント別進捗詳細

### 🤖 AI エンジン (Kotaro Engine)
**ステータス: ⚠️ 部分的稼働 (Backend Logic Mismatch)**
- **Backend (`kotaro_api.py`)**:
  - **バージョン**: V3.0表記だが、内部ロジックは **V4.6.1 (KotaroScorerV4)** を使用。
  - **VLM**: `Qwen2-VL-2B-Instruct` (via LMDeploy) を使用。`vision_core.py` (MiniCPM-V) は **未使用** です。
  - **生成ロジック**: `call_kotaro_generation_v3` という関数名ですが、V4のスコアを受け取って動作しています。
  - **課題**: API応答ヘッダーが "V3.0" や "V4.2" と混在しており、混乱の元になっています。

- **Scorer (`kotaro_scoring_v4.py`)**:
  - **ロジック**: V4.6.1「Anti-P04 Lock」「De-Cluster P01→P03」実装済み。
  - **ベンチマーク (V4.7)**: P06(30%), P11(26.7%), P12(26.7%) に偏りがあり、感情系パターン (P01, P05, P08-P10) が **0%** です。

- **Vision Core (`vision_core.py`)**:
  - **ステータス**: 🛑 **孤立 (Unused)**
  - MiniCPM-V 2.6 int4 実装ですが、APIサーバーからは呼び出されていません。完全にデッドコード化しているか、将来的な統合待ちの状態です。

### 💻 フロントエンド
**ステータス: 🏗️ 開発中 (Next.js)**
- **TextEditor (`TextEditor.tsx`)**:
  - `http://localhost:8000/generate` に接続確認済み。
  - `ScoringVisualization` コンポーネントでV4のフラグを表示可能です。
- **ImageEditor (`ImageEditor.tsx`)**:
  - `/api/cameko-search` や `/api/fact-check` への呼び出しがありますが、これはNext.jsのAPI Routeを指しており、`kotaro_api.py` とは別の経路です。

### 🔧 インフラ・スクリプト
**ステータス: ⚠️ 要修正 (Script Mismatch)**
- **`start_kotaro.sh` (WSL用)**: ❌ **破損/旧式**
  - Ollamaを起動しようとしていますが、現在のバックエンドは **LMDeploy (Port 23334)** を要求するため、このスクリプトではシステムが起動しません。
- **`start_lmdeploy_system.bat` (Windows用)**: ✅ **正常**
  - WSL側で `scripts/launch_qwen2.py` を起動し、Windows側でAPIを立ち上げる正しい構成になっています。

---

## 3. コードベースレビュー結果

### ⚠️ 重要課題 (Critical Issues)

1.  **起動スクリプトの不整合 (`start_kotaro.sh`)**
    - 現在のアーキテクチャ (LMDeploy必須) に対応しておらず、Ollamaを探しに行きます。これを実行するとAPIサーバーはバックエンドに接続できずエラーになります。
    - **推奨**: `start_lmdeploy_system.bat` と同等のロジック（`scripts/launch_qwen2.py` の起動）に書き換える必要があります。

2.  **Vision Coreの孤立 (`vision_core.py`)**
    - 高品質なMiniCPM-V実装ですが、APIから使われていません。Qwen2-VLで十分なのか、MiniCPM-Vを併用するのか（Plan Bのハイブリッド構成など）、方針決定が必要です。

3.  **APIバージョニングの混乱**
    - `kotaro_api.py`: Docstring="V3.0", FastAPI Title="V4.2", Health Check="3.0".
    - `call_kotaro_generation_v3` 関数がV4ロジックを担当している。
    - **推奨**: 全て **V4.x** に統一し、関数名もリファクタリングする。

4.  **Governance不整合 (P07 "尊い")**
    - `kotaro_api.py` のプロンプトでは「抽象語・逃げワード（尊い...）禁止」とありますが、`PATTERN_EXAMPLES` の P07 に「関係性が尊い」といった文言が含まれる可能性があります（要確認: コード上は `attack` 定義に含まれるが、生成例には "尊い" そのものは含まれていないかもしれません。しかし P07定義の `attack` は "関係性が尊い" です）。

### 🔍 ベンチマーク分析 (V4.7 Report)
- **結果**: P06 (キャラ), P11 (距離), P12 (場) が全体の **83.4%** を占有。
- **分析**: 「感情」を判定するスコア (C/D) が低く出る、または決定木ロジックが安全なパターン（P11/P12）に流れやすくなっています。
- **対策**: `kotaro_scoring_v4.py` の閾値調整が必要です。

---

## 4. 今後のアクションプラン (Next Steps)

### 直近 (今日〜明日)
1.  **スクリプト修復**: `start_kotaro.sh` を LMDeploy 対応に書き換える。
2.  **API整理**: `kotaro_api.py` のバージョン表記を V4.6 に統一し、不要なV3コードをクリーンアップ。
3.  **Vision Core方針決定**: `vision_core.py` を `kotaro_api.py` に統合するか（ダブルチェック用など）、削除するか決定。

### 中期 (今週中)
1.  **スコアリング調整**: V4.7の結果に基づき、P06/P11/P12 への偏りを是正する（P01/P08系が出やすくなるよう閾値を緩和）。
2.  **フロントエンド完全接続**: `ImageEditor` の機能をバックエンドAPIに接続検討。

---
*Report generated by Jules (AI Agent)*
