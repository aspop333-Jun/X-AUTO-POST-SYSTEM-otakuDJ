# 進捗管理レポート (2026-01-16) - コードレビュー特別版

## 1. プロジェクト概要
**プロジェクト名**: X-AUTO-POST-SYSTEM-otakuDJ
**目的**: イベント写真自動投稿システム（"CANDY虎太郎"ペルソナによる18文字エモコメント生成）
**現状ステータス**: 🔄 **フェーズ2.5 リファクタリング & 整合性確認**
**現在日時**: 2026-01-16

## 2. エグゼクティブ・サマリー
**【本日の実施内容】**
システム全体のコードレビューを実施し、**「APIの二重管理」「バージョン不整合」「起動スクリプトの破損」**という3つの重大な課題を特定しました。E2Eテストは成功していますが、内部実装にはレガシーコード（V2/V3時代の遺物）が多数残留しており、保守性を著しく低下させています。

---

## 3. コードレビュー詳細 (重要課題)

### 🚨 1. 起動スクリプトの不整合 (Critical)
- **ファイル**: `start_kotaro.sh`
- **問題**: `start_lmdeploy_system.bat` (Windows) は正しいバックエンド (`scripts/launch_qwen2.py`) を起動するのに対し、WSL用のシェルスクリプトは**廃止された `ollama serve` を起動しようとしています**。
- **影響**: WSL環境単体ではシステムが正しく起動しません。

### 🚨 2. APIサーバーの二重管理とポート競合
- **ファイル**: `kotaro_api.py` vs `api/main.py`
- **問題**: 両方のファイルが `port=8000` で FastAPI を起動する設定になっています。
    - `kotaro_api.py`: ローカルLLM (Qwen) 用、現在のメイン。
    - `api/main.py`: クラウド Gemini API 用、旧仕様または別用途。
- **影響**: 開発者がどちらを起動すべきか混乱する恐れがあり、同時起動できません。

### ⚠️ 3. Kotaro APIのバージョン情報の錯綜
- **ファイル**: `kotaro_api.py`
- **問題**:
    - コード内ヘッダー: `V3.0`
    - FastAPI定義: `title="Kotaro-Engine API (V4.2)"`
    - ヘルスチェック応答: `version: "3.0"`
    - 実装ロジック: スコアリングは `V4.6.1` (KotaroScorerV4)、生成ロジックは `V3.0` (`call_kotaro_generation_v3`)。
- **影響**: バージョン管理が形骸化しており、デバッグ時に混乱を招きます。

### ⚠️ 4. フロントエンドのレガシー定義残留
- **ファイル**: `next-app/src/components/editor/ScoringVisualization.tsx`
- **問題**: `CRITERIA_DEFINITIONS` に **60項目 (A01-D15)** の定義が残っていますが、現在のバックエンド (V4) はこれを返さず、代わりに `flags` (casual_moment 等) を返します。
- **影響**: コードが肥大化しており、将来的に誤った仕様参照の原因になります。

---

## 4. コンポーネント別ステータス確認

| コンポーネント | 現状バージョン | 判定 | 課題 |
|:---|:---|:---|:---|
| **Scoring Logic** | V4.6.1 | ✅ 正常 | P06/P11/P12への偏りあり（ベンチマーク結果より） |
| **Generation Logic** | V3.0 | ⚠️ 要更新 | V4スコアを活かしきれていない可能性 |
| **Backend API** | Mixed (V3/V4) | ❌ 混乱 | バージョン表記の統一が必要 |
| **Frontend UI** | V4対応済 | ⚠️ 警告 | レガシーコード(V2定義)の削除が必要 |
| **Startup Script** | Legacy | ❌ 破損 | LMDeploy対応への書き換え必須 |

---

## 5. Next Steps (優先度順)

1.  **起動スクリプトの修正 (High)**
    - `start_kotaro.sh` を修正し、Ollama ではなく `scripts/launch_qwen2.py` (LMDeploy) を起動するように変更する。
2.  **APIコードのクリーンアップ (Medium)**
    - `kotaro_api.py` のバージョン表記を実態に合わせて統一する。
    - 生成ロジック関数名を現状に合わせてリネーム検討。
3.  **レガシーファイルの整理 (Medium)**
    - `api/main.py` の役割を明確化するか、アーカイブする（`api/gemini_main.py` 等へリネーム）。
    - フロントエンドの `CRITERIA_DEFINITIONS` を V4 `flag_rules` に合わせて更新または削除。
4.  **スコアリングバランスの調整 (Low)**
    - V4.7ベンチマークで判明した P06, P11, P12 への偏りを修正するためのロジック調整。

---
*Report generated by Jules (AI Agent) - 2026-01-16*
