@echo off
chcp 65001 >nul 2>&1
setlocal EnableDelayedExpansion

:: =============================================================================
:: X Auto-Post System - 開発者ツール v2.0
:: =============================================================================
:: 起動方法:
::   エクスプローラーでこのファイルをダブルクリック
::   または コマンドプロンプトで dev.bat を実行
:: =============================================================================

set "ROOT_DIR=%~dp0"
set "NEXT_APP=%ROOT_DIR%next-app"

:: 引数があれば直接実行
if "%1"=="" goto main_menu
if /i "%1"=="help" goto show_help
if /i "%1"=="-h" goto show_help
if /i "%1"=="/?" goto show_help
if /i "%1"=="?" goto show_help
goto main_menu

:main_menu
cls
echo.
echo  [38;2;255;100;100m██╗  ██╗     █████╗ ██╗   ██╗████████╗ ██████╗ [0m
echo  [38;2;255;150;100m╚██╗██╔╝    ██╔══██╗██║   ██║╚══██╔══╝██╔═══██╗[0m
echo  [38;2;255;200;100m ╚███╔╝     ███████║██║   ██║   ██║   ██║   ██║[0m
echo  [38;2;100;200;255m ██╔██╗     ██╔══██║██║   ██║   ██║   ██║   ██║[0m
echo  [38;2;150;100;255m██╔╝ ██╗    ██║  ██║╚██████╔╝   ██║   ╚██████╔╝[0m
echo  [38;2;200;100;255m╚═╝  ╚═╝    ╚═╝  ╚═╝ ╚═════╝    ╚═╝    ╚═════╝ [0m
echo.
echo  [38;2;100;255;200m╔═══════════════════════════════════════════════════════════╗[0m
echo  [38;2;100;255;200m║[0m     [38;2;255;255;100m★[0m [1;97mX Auto-Post System - Developer Tools[0m [38;2;255;255;100m★[0m          [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m╠═══════════════════════════════════════════════════════════╣[0m
echo  [38;2;100;255;200m║[0m                                                           [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[1][0m [38;2;0;255;100m🚀[0m [97mアプリを起動[0m            [90m- 開発サーバーを起動[0m     [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[2][0m [38;2;255;200;0m📦[0m [97mセットアップ[0m            [90m- 初回インストール[0m       [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[3][0m [38;2;0;200;255m🔍[0m [97m環境チェック[0m            [90m- Node.js等の確認[0m        [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m                                                           [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[4][0m [38;2;255;100;100m🏗️[0m [97mビルド[0m                  [90m- 本番用ビルド作成[0m       [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[5][0m [38;2;200;100;255m🧪[0m [97mテスト[0m                  [90m- テストを実行[0m           [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m                                                           [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[6][0m [38;2;255;255;0m🧹[0m [97mクリーンアップ[0m          [90m- node_modules削除[0m       [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[7][0m [38;2;255;150;0m🔄[0m [97mリセット[0m                [90m- 完全な再インストール[0m   [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m                                                           [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[8][0m [38;2;0;255;255m💡[0m [97mヘルプ[0m                    [90m- このツールの使い方[0m     [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m   [38;2;100;200;255m[0][0m [38;2;255;100;100m❌[0m [97m終了[0m                                               [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m║[0m                                                           [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m╚═══════════════════════════════════════════════════════════╝[0m
echo.
set /p choice="  [38;2;100;255;200m▶[0m [97m番号を入力してEnter:[0m "

if "%choice%"=="1" goto app
if "%choice%"=="2" goto setup
if "%choice%"=="3" goto status
if "%choice%"=="4" goto build
if "%choice%"=="5" goto test
if "%choice%"=="6" goto clean
if "%choice%"=="7" goto reset
if "%choice%"=="8" goto show_help
if "%choice%"=="0" goto exit_app

echo.
echo  [38;2;255;100;100m[エラー][0m 無効な番号です。もう一度お試しください。
timeout /t 2 /nobreak >nul
goto main_menu

:: -----------------------------------------------------------------------------
:app
cls
call :show_header "アプリを起動"
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;0;255;100m▶[0m 開発サーバーを起動中...
echo    [90mURL: http://localhost:3000[0m
echo    [90m停止: Ctrl + C[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
cd /d "%NEXT_APP%"
call npm run dev
echo.
echo  [38;2;255;255;0m何かキーを押すとメニューに戻ります...[0m
pause >nul
goto main_menu

:: -----------------------------------------------------------------------------
:setup
cls
call :show_header "セットアップ"
call :check_node
if errorlevel 1 goto menu_return
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;255;200;0m▶[0m 依存関係をインストール中...
echo    [90m（初回は数分かかることがあります）[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
cd /d "%NEXT_APP%"
call npm install
if errorlevel 1 (
    echo.
    echo  [38;2;255;100;100m[エラー][0m インストールに失敗しました
) else (
    echo.
    echo  [38;2;0;255;100m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
    echo    [38;2;0;255;100m✓ セットアップ完了！[0m
    echo    [97m[1]を選んでアプリを起動できます[0m
    echo  [38;2;0;255;100m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
)
goto menu_return

:: -----------------------------------------------------------------------------
:status
cls
call :show_header "環境チェック"
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;0;200;255m🔍 環境状態[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
echo    [38;2;255;255;100mNode.js:[0m
node --version 2>nul && echo    [38;2;0;255;100m✓ インストール済み[0m || echo    [38;2;255;100;100m✗ 未インストール[0m
echo.
echo    [38;2;255;255;100mnpm:[0m
npm --version 2>nul && echo    [38;2;0;255;100m✓ インストール済み[0m || echo    [38;2;255;100;100m✗ 未インストール[0m
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;0;200;255m📦 パッケージ状態[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
if exist "%NEXT_APP%\node_modules" (
    echo    [38;2;0;255;100m✓ next-app/node_modules: インストール済み[0m
) else (
    echo    [38;2;255;255;0m○ next-app/node_modules: 未インストール[0m
    echo    [90m  → [2]セットアップ を実行してください[0m
)
echo.
goto menu_return

:: -----------------------------------------------------------------------------
:build
cls
call :show_header "ビルド"
call :check_node
if errorlevel 1 goto menu_return
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;255;100;100m▶[0m プロダクションビルド中...
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
cd /d "%NEXT_APP%"
call npm run build
if errorlevel 1 (
    echo.
    echo  [38;2;255;100;100m[エラー][0m ビルドに失敗しました
) else (
    echo.
    echo  [38;2;0;255;100m✓ ビルド完了！[0m
)
goto menu_return

:: -----------------------------------------------------------------------------
:test
cls
call :show_header "テスト"
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;200;100;255m▶[0m テストを実行中...
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
cd /d "%ROOT_DIR%"
call npm test
goto menu_return

:: -----------------------------------------------------------------------------
:clean
cls
call :show_header "クリーンアップ"
echo.
echo  [38;2;255;255;0m⚠ node_modules を削除しますか？[0m
echo  [90m（セットアップを再実行する必要があります）[0m
echo.
set /p confirm="  [38;2;255;255;0m▶[0m 削除する場合は y を入力: "
if /i not "%confirm%"=="y" (
    echo.
    echo  [90mキャンセルしました[0m
    goto menu_return
)
echo.
echo  [38;2;255;255;0m▶[0m クリーンアップ中...
if exist "%NEXT_APP%\node_modules" (
    rmdir /s /q "%NEXT_APP%\node_modules"
    echo  [38;2;0;255;100m✓ next-app/node_modules 削除完了[0m
) else (
    echo  [90m  next-app/node_modules は存在しません[0m
)
if exist "%ROOT_DIR%node_modules" (
    rmdir /s /q "%ROOT_DIR%node_modules"
    echo  [38;2;0;255;100m✓ ルート/node_modules 削除完了[0m
) else (
    echo  [90m  ルート/node_modules は存在しません[0m
)
echo.
echo  [38;2;0;255;100m✓ クリーンアップ完了！[0m
goto menu_return

:: -----------------------------------------------------------------------------
:reset
cls
call :show_header "リセット"
echo.
echo  [38;2;255;100;100m⚠ 完全リセットを実行しますか？[0m
echo  [90m（node_modules削除 + 再インストール）[0m
echo.
set /p confirm="  [38;2;255;100;100m▶[0m リセットする場合は y を入力: "
if /i not "%confirm%"=="y" (
    echo.
    echo  [90mキャンセルしました[0m
    goto menu_return
)
:: クリーン実行
echo.
echo  [38;2;255;255;0m▶[0m クリーンアップ中...
if exist "%NEXT_APP%\node_modules" rmdir /s /q "%NEXT_APP%\node_modules"
if exist "%ROOT_DIR%node_modules" rmdir /s /q "%ROOT_DIR%node_modules"
echo  [38;2;0;255;100m✓ クリーンアップ完了[0m
:: セットアップ実行
echo.
echo  [38;2;255;200;0m▶[0m 再インストール中...
cd /d "%NEXT_APP%"
call npm install
echo.
echo  [38;2;0;255;100m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;0;255;100m✓ リセット完了！[0m
echo  [38;2;0;255;100m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
goto menu_return

:: -----------------------------------------------------------------------------
:show_help
cls
echo.
echo  [38;2;100;255;200m╔═══════════════════════════════════════════════════════════════════════╗[0m
echo  [38;2;100;255;200m║[0m      [38;2;0;255;255m💡 開発ツール ヘルプ[0m                                              [38;2;100;255;200m║[0m
echo  [38;2;100;255;200m╚═══════════════════════════════════════════════════════════════════════╝[0m
echo.
echo  [38;2;255;255;100m▼ このツールの起動方法[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
echo    [38;2;0;255;100m方法1:[0m [97mdev.bat をダブルクリック[0m
echo           [90m→ エクスプローラーでdev.batを見つけてダブルクリック[0m
echo.
echo    [38;2;0;255;100m方法2:[0m [97mコマンドプロンプトから起動[0m
echo           [90m→ このフォルダでcmdを開いて「dev」または「dev.bat」と入力[0m
echo.
echo  [38;2;255;255;100m▼ 各機能の説明[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
echo    [38;2;100;200;255m[1] アプリを起動[0m     [90m- 開発サーバーを起動。ブラウザでlocalhost:3000[0m
echo    [38;2;100;200;255m[2] セットアップ[0m     [90m- 初回のみ実行。必要なパッケージをインストール[0m
echo    [38;2;100;200;255m[3] 環境チェック[0m     [90m- Node.jsなどがインストールされてるか確認[0m
echo    [38;2;100;200;255m[4] ビルド[0m           [90m- 本番用のファイルを作成[0m
echo    [38;2;100;200;255m[5] テスト[0m           [90m- テストコードを実行[0m
echo    [38;2;100;200;255m[6] クリーンアップ[0m   [90m- node_modulesを削除（容量節約）[0m
echo    [38;2;100;200;255m[7] リセット[0m         [90m- 削除して再インストール（問題解決に）[0m
echo.
echo  [38;2;255;255;100m▼ 初めて使う場合[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
echo    [38;2;255;200;0m1.[0m まず [38;2;255;200;0m[2] セットアップ[0m を実行
echo    [38;2;255;200;0m2.[0m 次に [38;2;0;255;100m[1] アプリを起動[0m を実行
echo    [38;2;255;200;0m3.[0m ブラウザで [38;2;0;200;255mhttp://localhost:3000[0m を開く
echo.
goto menu_return

:: -----------------------------------------------------------------------------
:exit_app
cls
echo.
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo    [38;2;255;255;100m★[0m ご利用ありがとうございました！ [38;2;255;255;100m★[0m
echo  [38;2;100;255;200m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
echo.
timeout /t 1 /nobreak >nul
goto end

:: -----------------------------------------------------------------------------
:menu_return
echo.
echo  [38;2;255;255;0m何かキーを押すとメニューに戻ります...[0m
pause >nul
goto main_menu

:: -----------------------------------------------------------------------------
:show_header
echo.
echo  [38;2;100;255;200m╔═══════════════════════════════════════════════════════════╗[0m
echo  [38;2;100;255;200m║[0m     [38;2;255;255;100m★[0m %~1 [38;2;255;255;100m★[0m
echo  [38;2;100;255;200m╚═══════════════════════════════════════════════════════════╝[0m
exit /b 0

:: -----------------------------------------------------------------------------
:check_node
node --version >nul 2>&1
if errorlevel 1 (
    echo.
    echo  [38;2;255;100;100m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
    echo    [38;2;255;100;100m✗ Node.js がインストールされていません[0m
    echo    [90mhttps://nodejs.org/ からダウンロードしてください[0m
    echo  [38;2;255;100;100m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m
    exit /b 1
)
exit /b 0

:end
endlocal
