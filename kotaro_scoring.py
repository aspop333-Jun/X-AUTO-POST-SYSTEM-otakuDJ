"""
Kotaro Comment Scoring Engine V2.2

60å€‹åˆ¤å®šåŸºæº– Ã— 12ãƒ‘ã‚¿ãƒ¼ãƒ³ Ã— 4ã‚µãƒ–å±æ€§ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

ä½¿ç”¨æ–¹æ³•:
    from kotaro_scoring import KotaroScorer
    scorer = KotaroScorer()
    result = scorer.analyze(image_path)
"""

from typing import Dict, List, Tuple, Optional
import random

# =============================================================================
# 12ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©ï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‹ã‚µãƒ–4é€£å˜ï¼‰
# =============================================================================

PATTERNS = {
    "P01": {
        "name": "ç›´çƒç§°è³›",
        "trigger": "å…¨èº«ãƒãƒ©ãƒ³ã‚¹å®Œæˆï¼‹æ­£é¢æ§‹å›³",
        "sub_ranking": ["ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«", "ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ"],
        "comment_templates": [
            "ã‚ã¡ã‚ƒãã¡ã‚ƒå¯æ„›ã„â€¦â¤",
            "ã™ã”ãç´ æ•µâ¤",
            "ã»ã‚“ã¨ãã‚Œã„âœ¨",
            "æœ€é«˜ï¼â¤",
        ],
    },
    "P02": {
        "name": "è¡¨æƒ…ãƒ•ã‚©ãƒ¼ã‚«ã‚¹",
        "trigger": "è‡ªç„¶ãªç¬‘é¡”ãƒ»ãµã¨å‡ºãŸè¡¨æƒ…",
        "sub_ranking": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«"],
        "comment_templates": [
            "ãã®ç¬‘é¡”ã€ã»ã‚“ã¨ç™’ã•ã‚Œã¾ã™ã­ğŸ˜",
            "ã«ã“ã£ã¨ã—ãŸè¡¨æƒ…ãŒæœ€é«˜â¤",
            "è‡ªç„¶ãªç¬‘é¡”ãŒã™ã¦ãâ¤",
            "ãµã‚ã£ã¨ã—ãŸç¬‘é¡”ã«ç™’ã•ã‚Œã‚‹ğŸ˜",
        ],
    },
    "P03": {
        "name": "ç›®ãƒ»è¦–ç·šãƒ•ã‚©ãƒ¼ã‚«ã‚¹",
        "trigger": "ç›®ãŒã‚­ãƒ¥ãƒ¼ãƒˆãƒ»ã‚¢ãƒƒãƒ—",
        "sub_ranking": ["ã‹ã‚ã„ã„", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«", "è¦ªè¿‘æ„Ÿ"],
        "comment_templates": [
            "ã¾ã£ã™ããªç›®ãŒã»ã‚“ã¨ã™ã¦ãâ¤",
            "ç›®ãŒã»ã‚“ã¨ç´ æ•µâ¤",
            "ç›®åŠ›ã™ã”ã„â€¦âœ¨",
            "å¸ã„è¾¼ã¾ã‚Œãã†ãªç›®â¤",
        ],
    },
    "P04": {
        "name": "é€æ˜æ„Ÿãƒ»é›°å›²æ°—",
        "trigger": "ãµã‚ã£ã¨æ˜ã‚‹ã„å†™çœŸ",
        "sub_ranking": ["ã‹ã‚ã„ã„", "ãã‚Œã„", "è¦ªè¿‘æ„Ÿ", "ã‚¯ãƒ¼ãƒ«"],
        "comment_templates": [
            "é€æ˜æ„Ÿã‚ã£ã¦ã€é›°å›²æ°—ã™ã”ãã„ã„ã§ã™ã­âœ¨",
            "é€æ˜æ„Ÿã¤ã‚ˆã™ãã¦å…‰ã«ãªã‚‹ãƒ¬ãƒ™ãƒ«â€¦âœ¨",
            "ãµã‚ã£ã¨ã—ãŸé›°å›²æ°—ãŒã™ã¦ãâ¤",
            "ç©ºæ°—ãŒãã‚Œã„âœ¨",
        ],
    },
    "P05": {
        "name": "ä»•è‰ãƒ»ä¸€ç¬åå¿œ",
        "trigger": "æ‰‹ã®ãƒãƒ¼ã‚ºãƒ»å‹•ãã®ä½™éŸ»",
        "sub_ranking": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ã‚¯ãƒ¼ãƒ«", "ãã‚Œã„"],
        "comment_templates": [
            "ãã®ä»•è‰ã€ã‚ã¡ã‚ƒãã¡ã‚ƒå¥½ãã§ã™ğŸ˜Š",
            "ãƒ”ãƒ¼ã‚¹ã‹ã‚ã„ã„â¤",
            "æŒ‡ãƒãƒ¼ãƒˆãŒã‚­ãƒ¥ãƒ¼ãƒˆâ¤",
            "ä¸€ç¬ã®è¡¨æƒ…ãŒã™ã¦ãğŸ˜",
        ],
    },
    "P06": {
        "name": "è¡£è£…ä¼¼åˆã„åº¦",
        "trigger": "ãƒãƒ¼ãƒ è¡£è£…ãƒ»ã‚³ã‚¹ãƒ—ãƒ¬ãŒç›®ç«‹ã¤",
        "sub_ranking": ["ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«", "ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ"],
        "comment_templates": [
            "ã“ã®è¡£è£…ã€ã»ã‚“ã¨ä¼¼åˆã£ã¦ã¾ã™ã­âœ¨",
            "ã‚³ã‚¹ãŒãƒãƒã£ã¦ã‚‹â¤",
            "è¡£è£…ã´ã£ãŸã‚Šâœ¨",
            "ã‚ã¡ã‚ƒä¼¼åˆã£ã¦ã‚‹â¤",
        ],
    },
    "P07": {
        "name": "ãƒãƒ¼ã‚ºå®Œæˆåº¦",
        "trigger": "æ±ºã‚ãƒãƒ¼ã‚ºãŒãƒãƒƒãƒãƒª",
        "sub_ranking": ["ã‚¯ãƒ¼ãƒ«", "ãã‚Œã„", "ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ"],
        "comment_templates": [
            "ãƒãƒ¼ã‚ºã°ã£ã¡ã‚Šæ±ºã¾ã£ã¦ã¾ã™ã­ğŸ‘",
            "æ±ºã¾ã£ã¦ã‚‹ï¼âœ¨",
            "ãƒãƒ¼ã‚ºå®Œç’§âœ¨",
            "ã‚«ãƒƒã‚³ã„ã„ï¼âœ¨",
        ],
    },
    "P08": {
        "name": "ã‚¤ãƒ™ãƒ³ãƒˆæ„Ÿ",
        "trigger": "äººæ··ã¿ãƒ»ãƒ–ãƒ¼ã‚¹èƒŒæ™¯ã‚ã‚Š",
        "sub_ranking": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«"],
        "comment_templates": [
            "ã‚¤ãƒ™ãƒ³ãƒˆã®ç©ºæ°—ä¼ã‚ã£ã¦ãã¾ã™ã­ï¼",
            "æ¥½ã—ãã†ï¼â¤",
            "ç››ã‚Šä¸ŠãŒã£ã¦ã‚‹âœ¨",
            "ã„ã„é›°å›²æ°—â¤",
        ],
    },
    "P09": {
        "name": "è¦ªè¿‘æ„Ÿ",
        "trigger": "è·é›¢ãŒè¿‘ã„æ§‹å›³",
        "sub_ranking": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«"],
        "comment_templates": [
            "ãªã‚“ã ã‹è¦ªè¿‘æ„Ÿã‚ã£ã¦ã„ã„ã§ã™ã­ğŸ˜Š",
            "è·é›¢æ„ŸãŒã„ã„â¤",
            "ã»ã£ã¨ã™ã‚‹ğŸ˜Š",
            "èº«è¿‘ãªæ„Ÿã˜ãŒã™ã¦ãâ¤",
        ],
    },
    "P10": {
        "name": "ã‚¯ãƒ¼ãƒ«å¯„ã‚Š",
        "trigger": "è¡¨æƒ…æ§ãˆã‚ãƒ»è½ã¡ç€ã",
        "sub_ranking": ["ã‚¯ãƒ¼ãƒ«", "ãã‚Œã„", "è¦ªè¿‘æ„Ÿ", "ã‹ã‚ã„ã„"],
        "comment_templates": [
            "è½ã¡ç€ã„ãŸé›°å›²æ°—ã€ã™ã”ãã„ã„ã§ã™ã€‚",
            "å¤§äººã£ã½ãã¦ã™ã¦ãâœ¨",
            "ä½™è£•ãŒã‚ã‚‹âœ¨",
            "ã‚¯ãƒ¼ãƒ«ã§ã‚«ãƒƒã‚³ã„ã„âœ¨",
        ],
    },
    "P11": {
        "name": "ã‚®ãƒ£ãƒƒãƒ—è¤’ã‚",
        "trigger": "è¡£è£…ã¨è¡¨æƒ…ã®å·®ãƒ»æ„å¤–æ€§",
        "sub_ranking": ["ã‚¯ãƒ¼ãƒ«", "ã‹ã‚ã„ã„", "ãã‚Œã„", "è¦ªè¿‘æ„Ÿ"],
        "comment_templates": [
            "ãã®ã‚®ãƒ£ãƒƒãƒ—ã€åå‰‡ã§ã™â€¦â¤",
            "æ„å¤–æ€§ãŒã™ã¦ãâœ¨",
            "ã‚®ãƒ£ãƒƒãƒ—ã«ã‚„ã‚‰ã‚ŒãŸâ¤",
            "åå‰‡ç´šã«å¯æ„›ã„â€¦â¤",
        ],
    },
    "P12": {
        "name": "ç·æ‹¬ä¸€è¨€",
        "trigger": "å®Œæˆåº¦é«˜ã„å…¨ä½“ã‚«ãƒƒãƒˆãƒ»è¤‡æ•°äºº",
        "sub_ranking": ["è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‹ã‚ã„ã„", "ã‚¯ãƒ¼ãƒ«"],
        "comment_templates": [
            "ä»Šæ—¥ã‚‚æœ€é«˜ã§ã—ãŸâœ¨",
            "ã•ã™ãŒï¼â¤",
            "å®‰å®šã®ã‹ã‚ã„ã•â¤",
            "ã„ã¤ã‚‚ç´ æ•µâœ¨",
        ],
    },
}


# =============================================================================
# 60å€‹åˆ¤å®šåŸºæº–
# =============================================================================

CRITERIA = [
    # === ãã‚Œã„ç³»ï¼ˆ15å€‹ï¼‰===
    {"id": "A01", "question": "æ­£é¢ã‚’å‘ã„ã¦ã„ã‚‹", "patterns": ["P01", "P03"], "sub": "ãã‚Œã„", "score": 3},
    {"id": "A02", "question": "å…¨èº«ãŒæ˜ ã£ã¦ã„ã‚‹", "patterns": ["P01", "P07"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A03", "question": "ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»æ›²ç·šãŒç¾ã—ã„", "patterns": ["P01", "P06"], "sub": "ãã‚Œã„", "score": 3},
    {"id": "A04", "question": "è¡£è£…ãŒæ˜ã‚‹ã„è‰²ï¼ˆç™½/é’ç³»ï¼‰", "patterns": ["P04"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A05", "question": "èƒŒæ™¯ã¨é¦´æŸ“ã‚“ã§ã„ã‚‹", "patterns": ["P04", "P08"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A06", "question": "ãƒãƒ¼ã‚ºãŒæ±ºã¾ã£ã¦ã„ã‚‹", "patterns": ["P07"], "sub": "ãã‚Œã„", "score": 3},
    {"id": "A07", "question": "ä½“ã®ãƒ©ã‚¤ãƒ³ãŒãã‚Œã„", "patterns": ["P07"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A08", "question": "é€æ˜æ„ŸãŒã‚ã‚‹ï¼ˆæ˜ã‚‹ã„å†™çœŸï¼‰", "patterns": ["P04"], "sub": "ãã‚Œã„", "score": 3},
    {"id": "A09", "question": "è¦–ç·šãŒã¾ã£ã™ã", "patterns": ["P03"], "sub": "ãã‚Œã„", "score": 3},
    {"id": "A10", "question": "é»’ç›®ãŒå¤§ããè¦‹ãˆã‚‹", "patterns": ["P03"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A11", "question": "è¡£è£…ã®å®Œæˆåº¦ãŒé«˜ã„", "patterns": ["P06"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A12", "question": "ã‚³ã‚¹ãƒ—ãƒ¬ãƒ»ã‚­ãƒ£ãƒ©è¡£è£…", "patterns": ["P06", "P11"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A13", "question": "è¤‡æ•°äººã§æ˜ ã£ã¦ã„ã‚‹", "patterns": ["P12"], "sub": "ãã‚Œã„", "score": 1},
    {"id": "A14", "question": "ãƒãƒ¼ãƒ è¡£è£…ãƒ»ãŠæƒã„", "patterns": ["P06", "P12"], "sub": "ãã‚Œã„", "score": 2},
    {"id": "A15", "question": "å†™çœŸå…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„", "patterns": ["P01", "P12"], "sub": "ãã‚Œã„", "score": 3},
    
    # === ã‹ã‚ã„ã„ç³»ï¼ˆ15å€‹ï¼‰===
    {"id": "B01", "question": "ç¬‘é¡”ã§ã‚ã‚‹", "patterns": ["P02"], "sub": "ã‹ã‚ã„ã„", "score": 3},
    {"id": "B02", "question": "ã«ã“ã£ã¨ã—ã¦ã„ã‚‹", "patterns": ["P02"], "sub": "ã‹ã‚ã„ã„", "score": 3},
    {"id": "B03", "question": "ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã‚’ã—ã¦ã„ã‚‹", "patterns": ["P05"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B04", "question": "æŒ‡ãƒãƒ¼ãƒˆã‚’ã—ã¦ã„ã‚‹", "patterns": ["P05"], "sub": "ã‹ã‚ã„ã„", "score": 3},
    {"id": "B05", "question": "æ‰‹ã‚’æŒ¯ã£ã¦ã„ã‚‹", "patterns": ["P05"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B06", "question": "å£è§’ãŒä¸ŠãŒã£ã¦ã„ã‚‹", "patterns": ["P02"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B07", "question": "ç›®ãŒç¬‘ã£ã¦ã„ã‚‹", "patterns": ["P02", "P03"], "sub": "ã‹ã‚ã„ã„", "score": 3},
    {"id": "B08", "question": "ãµã‚ã£ã¨ã—ãŸé›°å›²æ°—", "patterns": ["P02", "P04"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B09", "question": "ä½•ã‹ã‚’æŒã£ã¦ã„ã‚‹ï¼ˆãƒãƒ™ãƒ«ãƒ†ã‚£ç­‰ï¼‰", "patterns": ["P02", "P08"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B10", "question": "é ¬ãŒä¸¸ã„ãƒ»æŸ”ã‚‰ã‹ãã†", "patterns": ["P02"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B11", "question": "è¡£è£…ãŒãƒ”ãƒ³ã‚¯ãƒ»ãƒ‘ã‚¹ãƒ†ãƒ«ç³»", "patterns": ["P04"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B12", "question": "å°ç‰©ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãŒå¯æ„›ã„", "patterns": ["P05", "P06"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B13", "question": "ã‚¤ãƒ™ãƒ³ãƒˆã§æ¥½ã—ãã†", "patterns": ["P08"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B14", "question": "å‹•ãã®ã‚ã‚‹ä»•è‰", "patterns": ["P05"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    {"id": "B15", "question": "è‡ªç„¶ä½“ãƒ»ä½œã‚Šè¾¼ã¿ã™ããªã„", "patterns": ["P02", "P09"], "sub": "ã‹ã‚ã„ã„", "score": 2},
    
    # === ã‚¯ãƒ¼ãƒ«ç³»ï¼ˆ15å€‹ï¼‰===
    {"id": "C01", "question": "è¡¨æƒ…ãŒæ§ãˆã‚", "patterns": ["P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C02", "question": "è½ã¡ç€ã„ãŸé›°å›²æ°—", "patterns": ["P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C03", "question": "å¤§äººã£ã½ã„", "patterns": ["P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C04", "question": "è¡£è£…ãŒé»’ãƒ»ãƒ€ãƒ¼ã‚¯ç³»", "patterns": ["P06", "P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 2},
    {"id": "C05", "question": "ã‚¯ãƒ¼ãƒ«ãªè¦–ç·š", "patterns": ["P03", "P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C06", "question": "ä½™è£•ãŒã‚ã‚‹è¡¨æƒ…", "patterns": ["P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 2},
    {"id": "C07", "question": "ãƒ—ãƒ­ã£ã½ã•ãŒã‚ã‚‹", "patterns": ["P07", "P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 2},
    {"id": "C08", "question": "æ±ºã‚ãƒãƒ¼ã‚ºãŒãƒãƒƒãƒãƒª", "patterns": ["P07"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C09", "question": "è¡£è£…ã¨ãƒãƒ¼ã‚ºã®å®Œæˆåº¦é«˜ã„", "patterns": ["P01", "P07"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 2},
    {"id": "C10", "question": "ã‚«ãƒƒã‚³ã„ã„ç³»ã®è¡£è£…", "patterns": ["P06", "P07"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 2},
    {"id": "C11", "question": "ã‚­ãƒªãƒƒã¨ã—ãŸè¡¨æƒ…", "patterns": ["P10"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 2},
    {"id": "C12", "question": "ç›®åŠ›ãŒå¼·ã„", "patterns": ["P03"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C13", "question": "ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ»ãƒ¬ãƒ¼ã‚¹èƒŒæ™¯", "patterns": ["P08"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 1},
    {"id": "C14", "question": "è¡£è£…ã¨è¡¨æƒ…ã®ã‚®ãƒ£ãƒƒãƒ—", "patterns": ["P11"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    {"id": "C15", "question": "æ„å¤–æ€§ãŒã‚ã‚‹", "patterns": ["P11"], "sub": "ã‚¯ãƒ¼ãƒ«", "score": 3},
    
    # === è¦ªè¿‘æ„Ÿç³»ï¼ˆ15å€‹ï¼‰===
    {"id": "D01", "question": "ã‚«ãƒ¡ãƒ©ã¨ã®è·é›¢ãŒè¿‘ã„", "patterns": ["P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 3},
    {"id": "D02", "question": "å®‰å¿ƒæ„ŸãŒã‚ã‚‹è¡¨æƒ…", "patterns": ["P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 3},
    {"id": "D03", "question": "ç›®ç·šãŒå„ªã—ã„", "patterns": ["P02", "P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D04", "question": "ã»ã£ã¨ã™ã‚‹é›°å›²æ°—", "patterns": ["P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D05", "question": "è‡ªç„¶ãªç¬‘é¡”ï¼ˆä½œã‚Šç¬‘ã„ã˜ã‚ƒãªã„ï¼‰", "patterns": ["P02", "P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 3},
    {"id": "D06", "question": "è©±ã—ã‹ã‘ã¦ãã‚Œãã†", "patterns": ["P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D07", "question": "ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´ã®é›°å›²æ°—", "patterns": ["P08"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D08", "question": "äººæ··ã¿ãƒ»ãƒ–ãƒ¼ã‚¹èƒŒæ™¯", "patterns": ["P08"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D09", "question": "æ€ã„å‡ºæ„ŸãŒã‚ã‚‹", "patterns": ["P08", "P12"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D10", "question": "ãµã¨ã—ãŸç¬é–“ã‚’æ‰ãˆãŸ", "patterns": ["P02", "P05"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D11", "question": "æŸ”ã‚‰ã‹ã„é›°å›²æ°—", "patterns": ["P04", "P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D12", "question": "ã•ã™ãŒæ„Ÿãƒ»å®‰å®šæ„Ÿ", "patterns": ["P12"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D13", "question": "ã„ã¤ã‚‚é€šã‚Šã®è‰¯ã•", "patterns": ["P12"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D14", "question": "ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ä»²é–“æ„Ÿ", "patterns": ["P12"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 2},
    {"id": "D15", "question": "ç™’ã•ã‚Œã‚‹", "patterns": ["P02", "P09"], "sub": "è¦ªè¿‘æ„Ÿ", "score": 3},
]


# =============================================================================
# ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ V2.3ï¼ˆãƒãƒ£ãƒƒãƒ”ãƒ¼æŒ‡æ‘˜åæ˜ ç‰ˆï¼‰
# =============================================================================

# 4é€£å˜é †åºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ï¼‰
SUB_ORDER = {
    "P01": ["ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«", "ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ"],
    "P02": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«"],
    "P03": ["ã‹ã‚ã„ã„", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«", "è¦ªè¿‘æ„Ÿ"],
    "P04": ["ã‹ã‚ã„ã„", "ãã‚Œã„", "è¦ªè¿‘æ„Ÿ", "ã‚¯ãƒ¼ãƒ«"],
    "P05": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ã‚¯ãƒ¼ãƒ«", "ãã‚Œã„"],
    "P06": ["ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«", "ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ"],
    "P07": ["ã‚¯ãƒ¼ãƒ«", "ãã‚Œã„", "ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ"],
    "P08": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«"],
    "P09": ["ã‹ã‚ã„ã„", "è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‚¯ãƒ¼ãƒ«"],
    "P10": ["ã‚¯ãƒ¼ãƒ«", "ãã‚Œã„", "è¦ªè¿‘æ„Ÿ", "ã‹ã‚ã„ã„"],
    "P11": ["ã‚¯ãƒ¼ãƒ«", "ã‹ã‚ã„ã„", "ãã‚Œã„", "è¦ªè¿‘æ„Ÿ"],
    "P12": ["è¦ªè¿‘æ„Ÿ", "ãã‚Œã„", "ã‹ã‚ã„ã„", "ã‚¯ãƒ¼ãƒ«"],
}


class KotaroScorer:
    """Kotaroã‚³ãƒ¡ãƒ³ãƒˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ V2.3"""
    
    def __init__(self):
        self.patterns = PATTERNS
        self.criteria = CRITERIA
        self.sub_order = SUB_ORDER
    
    def score_from_answers(self, answers: Dict[str, bool]) -> Tuple[str, Dict[str, int], Dict[str, Dict[str, int]]]:
        """
        60å€‹ã®åˆ¤å®šåŸºæº–ã®å›ç­”ã‹ã‚‰ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
        
        Args:
            answers: {"A01": True, "A02": False, ...} å½¢å¼ã®å›ç­”
            
        Returns:
            (æœ€é©ãƒ‘ã‚¿ãƒ¼ãƒ³ID, ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¹ã‚³ã‚¢è¾æ›¸, ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã‚µãƒ–ã‚¹ã‚³ã‚¢è¾æ›¸)
        """
        # ã‚¹ã‚³ã‚¢åˆæœŸåŒ–
        pattern_scores = {f"P{i:02d}": 0 for i in range(1, 13)}
        
        # â˜…ä¿®æ­£ç‚¹ï¼šãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã«sub_scoresã‚’æŒã¤
        sub_by_pattern = {
            f"P{i:02d}": {"ãã‚Œã„": 0, "ã‹ã‚ã„ã„": 0, "ã‚¯ãƒ¼ãƒ«": 0, "è¦ªè¿‘æ„Ÿ": 0}
            for i in range(1, 13)
        }
        
        # å›ç­”ã«åŸºã¥ã„ã¦ã‚¹ã‚³ã‚¢åŠ ç®—
        for criterion in self.criteria:
            if answers.get(criterion["id"], False):
                # ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¹ã‚³ã‚¢åŠ ç®—
                for pattern in criterion["patterns"]:
                    pattern_scores[pattern] += 1
                    # â˜…ä¿®æ­£ç‚¹ï¼šãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®sub_scoresã«åŠ ç®—
                    sub_by_pattern[pattern][criterion["sub"]] += criterion["score"]
        
        # æœ€é«˜ã‚¹ã‚³ã‚¢ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç‰¹å®š
        max_score = max(pattern_scores.values())
        top_patterns = [p for p, s in pattern_scores.items() if s == max_score]
        
        if len(top_patterns) == 1:
            # å˜ç‹¬1ä½
            best_pattern = top_patterns[0]
        else:
            # åŒç‚¹ â†’ 4é€£å˜é †ã§æ¯”è¼ƒ
            best_pattern = self._resolve_tie_by_4ren(top_patterns, sub_by_pattern)
        
        return best_pattern, pattern_scores, sub_by_pattern
    
    def _resolve_tie_by_4ren(self, tied: List[str], sub_by_pattern: Dict[str, Dict[str, int]]) -> Optional[str]:
        """
        4é€£å˜é †ã«æ¯”è¼ƒã—ã¦å·®ãŒä»˜ã„ãŸã‚‰ç¢ºå®š
        
        Args:
            tied: åŒç‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒªã‚¹ãƒˆ
            sub_by_pattern: ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®ã‚µãƒ–ã‚¹ã‚³ã‚¢
            
        Returns:
            ç¢ºå®šãƒ‘ã‚¿ãƒ¼ãƒ³IDã€ã¾ã åŒç‚¹ãªã‚‰None
        """
        for rank in range(4):
            best = None
            best_val = -1
            
            for p in tied:
                sub_attr = self.sub_order[p][rank]  # ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®#rankå±æ€§
                val = sub_by_pattern[p].get(sub_attr, 0)
                if val > best_val:
                    best = p
                    best_val = val
            
            # ãã®rankã§æœ€é«˜å€¤ãŒä¸€æ„ã‹ï¼Ÿ
            tops = [
                p for p in tied 
                if sub_by_pattern[p].get(self.sub_order[p][rank], 0) == best_val
            ]
            
            if len(tops) == 1:
                return best
            
            # ã¾ã åŒç‚¹ãªã‚‰æ¬¡ã®rankã¸
            tied = tops
        
        # 4é€£å˜å…¨éƒ¨è¦‹ã¦ã‚‚åŒç‚¹ â†’ ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆå¾Œã§VLM 2æŠã«ç½®ãæ›ãˆï¼‰
        return random.choice(tied) if tied else None
    
    def get_comment(self, pattern_id: str, sub_by_pattern: Optional[Dict[str, Dict[str, int]]] = None) -> str:
        """
        ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã„ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆï¼ˆæºã‚‰ãä»˜ãï¼‰
        """
        pattern = self.patterns[pattern_id]
        templates = pattern["comment_templates"]
        
        # ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠï¼ˆæºã‚‰ãï¼‰
        return random.choice(templates)
    
    def get_tied_patterns_for_vlm(self, pattern_scores: Dict[str, int]) -> Optional[List[str]]:
        """
        VLMã§åˆ¤æ–­ãŒå¿…è¦ãªåŒç‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿”ã™
        """
        max_score = max(pattern_scores.values())
        tied = [p for p, s in pattern_scores.items() if s == max_score]
        
        if len(tied) > 1:
            return tied
        return None
    
    def build_vlm_tiebreaker_prompt(self, tied_patterns: List[str]) -> str:
        """
        åŒç‚¹æ™‚ã«VLMã«æŠ•ã’ã‚‹2æŠãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        """
        options = []
        for i, pattern_id in enumerate(tied_patterns):
            pattern = self.patterns[pattern_id]
            options.append(f"{i+1}. {pattern['trigger']}")
        
        prompt = f"""ã“ã®å†™çœŸã¯ä»¥ä¸‹ã®ã©ã¡ã‚‰ã®ç‰¹å¾´ãŒå¼·ã„ã§ã™ã‹ï¼Ÿç•ªå·ã§ç­”ãˆã¦ãã ã•ã„ã€‚

{chr(10).join(options)}

å›ç­”ï¼ˆç•ªå·ã®ã¿ï¼‰:"""
        
        return prompt


# =============================================================================
# VLMã«æŠ•ã’ã‚‹60å€‹åˆ¤å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# =============================================================================

def build_criteria_check_prompt() -> str:
    """60å€‹ã®åˆ¤å®šåŸºæº–ã‚’VLMã«æŠ•ã’ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""
    
    questions = []
    for c in CRITERIA:
        questions.append(f'{c["id"]}: {c["question"]}')
    
    prompt = f"""ã“ã®å†™çœŸã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®60å€‹ã®é …ç›®ãã‚Œãã‚Œã«è©²å½“ã™ã‚‹ã‹ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚
è©²å½“ã™ã‚‹å ´åˆã¯1ã€è©²å½“ã—ãªã„å ´åˆã¯0ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

å›ç­”å½¢å¼: ID:0 ã¾ãŸã¯ ID:1 ã®å½¢å¼ã§ã€ã™ã¹ã¦1è¡Œã§å›ç­”ã€‚
ä¾‹: A01:1 A02:0 A03:1 ...

--- åˆ¤å®šé …ç›® ---
{chr(10).join(questions)}

å›ç­”:"""
    
    return prompt


def parse_criteria_response(response: str) -> Dict[str, bool]:
    """VLMã®å›ç­”ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦è¾æ›¸ã«å¤‰æ›"""
    answers = {}
    
    # A01:1 A02:0 å½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹
    import re
    matches = re.findall(r'([A-D]\d{2}):([01])', response)
    
    for id_, value in matches:
        answers[id_] = (value == '1')
    
    return answers


# =============================================================================
# ãƒ†ã‚¹ãƒˆç”¨
# =============================================================================

if __name__ == "__main__":
    scorer = KotaroScorer()
    
    # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼å›ç­”ï¼ˆç¬‘é¡”ï¼‹ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã®å†™çœŸã‚’æƒ³å®šï¼‰
    test_answers = {
        "A01": True,   # æ­£é¢ã‚’å‘ã„ã¦ã„ã‚‹
        "B01": True,   # ç¬‘é¡”ã§ã‚ã‚‹
        "B02": True,   # ã«ã“ã£ã¨ã—ã¦ã„ã‚‹
        "B03": True,   # ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã‚’ã—ã¦ã„ã‚‹
        "B07": True,   # ç›®ãŒç¬‘ã£ã¦ã„ã‚‹
        "D05": True,   # è‡ªç„¶ãªç¬‘é¡”
    }
    
    pattern, p_scores, s_scores = scorer.score_from_answers(test_answers)
    comment = scorer.get_comment(pattern)
    
    print("=" * 50)
    print("ğŸ¯ Kotaro Scoring Engine Test")
    print("=" * 50)
    print(f"\nåˆ¤å®šãƒ‘ã‚¿ãƒ¼ãƒ³: {pattern} ({scorer.patterns[pattern]['name']})")
    print(f"ã‚³ãƒ¡ãƒ³ãƒˆ: {comment}")
    print(f"\nãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¹ã‚³ã‚¢: {p_scores}")
    print(f"ã‚µãƒ–ã‚¹ã‚³ã‚¢: {s_scores}")
